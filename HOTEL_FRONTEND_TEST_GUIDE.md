# 酒店预订功能前端测试指南

## 测试前准备

### 1. 确保后端服务运行
```bash
cd backend
npm start
# 服务应该在 http://localhost:3001 运行
```

### 2. 确保前端服务运行
```bash
cd frontend
npm start
# 应用应该在 http://localhost:3000 运行
```

### 3. 确保权限配置
```bash
cd backend/scripts
node initRolePermissions.js
# 确保 admin 角色有所有酒店权限
```

## 测试场景

### 场景 1: Tab 切换功能

**测试步骤：**
1. 访问 `http://localhost:3000/flight/search`
2. 验证页面显示两个 Tab：
   - ✅ "机票预订" Tab（默认选中）
   - ✅ "酒店预订" Tab
3. 点击"酒店预订" Tab
4. 验证：
   - ✅ Tab 切换成功
   - ✅ 显示酒店搜索表单
   - ✅ 机票搜索表单隐藏
5. 点击"机票预订" Tab
6. 验证：
   - ✅ Tab 切换回机票
   - ✅ 机票搜索表单显示
   - ✅ 酒店搜索表单隐藏

**预期结果：**
- Tab 切换流畅
- 两个 Tab 的状态完全独立
- 机票功能完全不受影响

---

### 场景 2: 酒店搜索功能

**测试步骤：**
1. 切换到"酒店预订" Tab
2. 填写搜索表单：
   - 城市：选择"New York"或输入"NYC"
   - 入住日期：选择未来30天的日期
   - 退房日期：选择入住日期后2天
   - 成人：1
   - 儿童：0
   - 房间：1
3. 点击"搜索"按钮
4. 验证：
   - ✅ 显示加载状态
   - ✅ 搜索成功后显示酒店列表
   - ✅ 酒店列表包含：酒店名称、地址、价格、评分
   - ✅ 可以点击酒店卡片查看详情

**预期结果：**
- 搜索功能正常
- 酒店列表正确显示
- 价格和评分信息正确

---

### 场景 3: 酒店详情页

**测试步骤：**
1. 在酒店列表中点击一个酒店
2. 验证详情页显示：
   - ✅ 酒店名称
   - ✅ 地址信息
   - ✅ 评分（如果有）
   - ✅ 价格信息
   - ✅ 入住/退房日期
   - ✅ 房间信息
   - ✅ 取消政策
   - ✅ "立即预订"按钮
3. 点击"返回"按钮
4. 验证：
   - ✅ 返回到搜索页面
   - ✅ 保持酒店 Tab 状态
   - ✅ 搜索结果保留

**预期结果：**
- 详情页信息完整
- 导航功能正常
- 状态保持正确

---

### 场景 4: 酒店预订流程（端到端测试）

#### 4.1 准备测试数据

**前置条件：**
- 至少有一个状态为 `approved` 或 `draft` 的差旅申请
- 如果没有，先创建一个差旅申请并审批通过

#### 4.2 步骤 1：选择差旅申请

**测试步骤：**
1. 在酒店详情页点击"立即预订"
2. 验证预订表单显示：
   - ✅ 步骤指示器显示"选择差旅申请"
   - ✅ 差旅申请下拉列表显示可用的申请
   - ✅ 显示差旅申请编号和标题
3. 选择一个差旅申请
4. 点击"下一步"

**预期结果：**
- 差旅申请列表正确加载
- 只能选择已审批或草稿状态的申请
- 验证必填字段

#### 4.3 步骤 2：填写客人信息

**测试步骤：**
1. 验证表单显示：
   - ✅ 默认有一个客人信息表单
   - ✅ 自动填充当前用户信息（如果可用）
   - ✅ 显示"添加客人"按钮
2. 填写客人信息：
   - 名字：填写（如：John）
   - 姓氏：填写（如：Doe）
   - 邮箱：填写有效邮箱（如：john.doe@example.com）
   - 电话：填写（可选）
3. 点击"添加客人"按钮（如果需要多个客人）
4. 填写第二个客人信息
5. 填写特殊要求（可选）
6. 点击"下一步"

**验证：**
- ✅ 必填字段验证（名字、姓氏、邮箱）
- ✅ 邮箱格式验证
- ✅ 可以添加多个客人（最多9个）
- ✅ 可以删除客人（至少保留1个）

**预期结果：**
- 表单验证正常
- 数据格式正确
- 可以添加/删除客人

#### 4.4 步骤 3：确认预订

**测试步骤：**
1. 验证确认页面显示：
   - ✅ 酒店信息摘要
   - ✅ 价格信息
   - ✅ 入住/退房日期
   - ✅ 客人数量
   - ✅ 房间数量
2. 检查所有信息是否正确
3. 点击"提交预订"按钮
4. 验证：
   - ✅ 显示提交中状态
   - ✅ 预订成功后跳转到预订管理页
   - ✅ 显示成功通知

**预期结果：**
- 预订信息确认正确
- 预订提交成功
- 跳转到正确的页面

#### 4.5 验证数据库数据

**验证步骤：**
1. 检查数据库中的 `HotelBooking` 集合
2. 验证新创建的预订记录：
   - ✅ `travelId` 正确关联
   - ✅ `employee` 是当前用户ID
   - ✅ `guests` 数组格式正确
   - ✅ `hotelOffer` 是完整的报价对象
   - ✅ `offerId` 正确
   - ✅ `checkIn` 和 `checkOut` 日期正确
   - ✅ `price` 信息完整
   - ✅ `status` 为 'confirmed'

3. 检查关联的 `Travel` 记录：
   - ✅ `bookings` 数组中包含新预订
   - ✅ `estimatedCost` 已更新
   - ✅ 预订类型为 'hotel'

**预期结果：**
- 数据库数据格式完全正确
- 关联关系正确
- 数据一致性保证

---

### 场景 5: 从差旅申请跳转

**测试步骤：**
1. 访问差旅申请详情页
2. 点击"预订酒店"按钮（如果存在）
3. 验证：
   - ✅ 跳转到搜索页面
   - ✅ 自动切换到酒店 Tab
   - ✅ 搜索条件自动填充：
     - 城市：从差旅申请的目的地提取
     - 入住日期：从差旅申请的 startDate
     - 退房日期：从差旅申请的 endDate
4. 完成预订流程

**预期结果：**
- 跳转功能正常
- 预填充数据正确
- 预订流程完整

---

### 场景 6: 错误处理测试

#### 6.1 搜索错误
- 测试无搜索结果的情况
- 测试 API 错误的情况
- 验证错误提示显示

#### 6.2 预订错误
- 测试未选择差旅申请的情况
- 测试客人信息不完整的情况
- 测试邮箱格式错误的情况
- 测试预订 API 失败的情况

**预期结果：**
- 错误提示清晰
- 用户知道如何修复错误

---

## 数据格式验证清单

### 预订提交数据格式检查

在浏览器开发者工具的 Network 标签中，检查提交的请求数据：

```javascript
// POST /api/hotels/bookings
{
  travelId: "ObjectId字符串",  // ✅ 必填
  offerId: "报价ID字符串",      // ✅ 必填
  hotelOffer: {                 // ✅ 必填：完整对象
    hotel: { ... },
    offers: [ ... ],
    ...
  },
  guests: [                     // ✅ 必填：数组格式
    {
      id: "GUEST_1",            // ✅ 必填：String
      name: {
        firstName: "John",      // ✅ 必填：String, trim
        lastName: "Doe",         // ✅ 必填：String, trim
      },
      contact: {
        emailAddress: "john@example.com", // ✅ 必填：String, lowercase
        phones: [{               // ✅ 可选：数组
          deviceType: "MOBILE",  // ✅ enum: MOBILE, LANDLINE
          countryCallingCode: "+86",
          number: "13800138000",
        }],
      },
    }
  ],
  specialRequests: "特殊要求",  // ✅ 可选
}
```

### 数据库记录格式检查

使用 MongoDB 客户端或脚本检查：

```javascript
// 查询最新创建的预订
db.hotelbookings.find().sort({ createdAt: -1 }).limit(1).pretty()

// 验证字段：
// ✅ travelId: ObjectId
// ✅ employee: ObjectId
// ✅ guests: 数组，格式正确
// ✅ hotelOffer: 完整对象
// ✅ offerId: String
// ✅ checkIn: Date
// ✅ checkOut: Date
// ✅ price: { total, currency, base, taxes }
// ✅ status: 'confirmed'
```

---

## 测试检查清单

### 功能测试
- [ ] Tab 切换功能正常
- [ ] 酒店搜索功能正常
- [ ] 酒店列表显示正常
- [ ] 酒店详情页正常
- [ ] 预订表单三步流程正常
- [ ] 差旅申请选择正常
- [ ] 客人信息表单正常
- [ ] 预订提交成功

### 数据格式测试
- [ ] guests 数组格式符合数据库要求
- [ ] hotelOffer 是完整的报价对象
- [ ] offerId 正确传递
- [ ] travelId 必填验证
- [ ] 日期格式正确（YYYY-MM-DD）
- [ ] 邮箱格式验证
- [ ] 电话格式验证

### 集成测试
- [ ] 从差旅申请跳转到酒店搜索
- [ ] 预订成功后更新差旅申请
- [ ] 预订列表显示正确
- [ ] 预订详情显示正确

### 错误处理测试
- [ ] 搜索错误提示正确
- [ ] 表单验证错误提示正确
- [ ] API 错误处理正确
- [ ] 网络错误处理正确

### 用户体验测试
- [ ] 加载状态显示
- [ ] 成功/错误通知显示
- [ ] 表单验证提示清晰
- [ ] 导航流程顺畅

---

## 常见问题排查

### 问题 1: Tab 切换后页面空白
**可能原因：**
- 组件导入错误
- 路由配置错误

**解决方法：**
- 检查浏览器控制台错误
- 检查组件导入路径
- 检查路由配置

### 问题 2: 酒店搜索无结果
**可能原因：**
- API 调用失败
- 城市代码不正确
- 日期范围无可用酒店

**解决方法：**
- 检查网络请求
- 尝试其他城市（如 NYC, PAR）
- 检查后端日志

### 问题 3: 预订提交失败
**可能原因：**
- 数据格式不正确
- 差旅申请状态不允许
- API 错误

**解决方法：**
- 检查浏览器 Network 标签中的请求数据
- 检查后端日志
- 验证差旅申请状态

### 问题 4: 权限错误
**可能原因：**
- 用户角色没有酒店权限
- 权限配置未更新

**解决方法：**
- 运行 `node backend/scripts/initRolePermissions.js`
- 检查用户角色权限
- 检查前端权限配置

---

## 测试报告模板

```
# 酒店预订功能前端测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: 
**测试环境**: 开发环境

## 测试结果摘要

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| Tab 切换 | ✅/❌ | |
| 酒店搜索 | ✅/❌ | |
| 酒店列表 | ✅/❌ | |
| 酒店详情 | ✅/❌ | |
| 预订流程 | ✅/❌ | |
| 数据格式 | ✅/❌ | |
| 错误处理 | ✅/❌ | |

## 详细测试结果

### 场景 1: Tab 切换
- 结果：✅ 通过 / ❌ 失败
- 问题描述：
- 截图：

### 场景 2: 酒店搜索
- 结果：✅ 通过 / ❌ 失败
- 问题描述：
- 截图：

...

## 发现的问题

1. 问题描述
   - 严重程度：高/中/低
   - 复现步骤：
   - 预期行为：
   - 实际行为：

## 建议

1. 改进建议
2. 优化建议
```

---

**文档版本**: 1.0  
**创建日期**: 2025-12-21  
**最后更新**: 2025-12-21

