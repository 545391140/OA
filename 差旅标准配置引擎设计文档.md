# 差旅标准配置引擎设计文档

## 文档信息
- **文档名称**: 差旅标准配置引擎设计文档
- **版本**: v2.1
- **创建日期**: 2025-12-21
- **更新日期**: 2025-12-21
- **文档类型**: 技术设计文档
- **更新内容**: 新增费用项约束条件功能，支持72种常见约束场景

---

## 一、概述

### 1.1 设计目标

差旅标准配置引擎是一个**通用、灵活、可扩展**的规则配置系统，旨在：

- **通用性**: 支持任意组织架构、职位体系、地理区域的差旅标准配置
- **灵活性**: 支持复杂的条件组合、多维度匹配、动态规则优先级
- **可扩展性**: 易于添加新的条件类型、操作符、费用类型
- **高性能**: 高效的规则匹配算法，支持大量规则快速匹配
- **易用性**: 提供直观的配置界面和API，降低配置复杂度

### 1.2 核心特性

1. **多维度条件匹配**
   - 支持29种条件类型：国家、城市、城市级别、部门、职位、职位级别、角色、项目代码、员工类型、组织类型、管理级别、职位类别，以及差旅天数、差旅类型、差旅目的、总金额、人数、距离等17种差旅相关条件
   - 支持条件组（OR逻辑）和组内条件（AND逻辑）的灵活组合

2. **动态优先级机制**
   - 支持规则优先级配置（0-100）
   - 自动选择优先级最高的匹配规则
   - 支持多规则合并策略

3. **费用标准配置**
   - 费用项来源于费用项管理模块，可动态新增、编辑和删除
   - **费用类型定义**：
     - **交通费用**：机票、火车票、汽车票等交通相关费用
     - **住宿费用**：酒店、宾馆等住宿相关费用
     - **餐费**：早餐、午餐、晚餐等餐饮费用
     - **其他费用**：通讯费、签证费、保险费、办公用品、培训费、娱乐费等
   - **费用限额类型**：
     - **固定限额（FIXED）**：设置固定的金额上限，实际费用不能超过该限额
     - **范围限额（RANGE）**：设置最小值和最大值范围，实际费用必须在该范围内
     - **实报实销（ACTUAL）**：无金额限制，按实际发生费用报销
     - **按比例（PERCENTAGE）**：基于基础金额按百分比计算限额
   - **计算单位及计算规则**：
     - **按天（PER_DAY）**：限额金额 × 差旅天数，适用于住宿费、餐费等按天计算的费用
     - **按次（PER_TRIP）**：限额金额 × 1，按差旅单号计算（整个差旅申请只计算一次），适用于签证费、保险费、洗衣费等
     - **按公里（PER_KM）**：限额金额 × 距离（公里），适用于按距离计算的交通费用
     - **按人（PER_PERSON）**：限额金额 × 人数，适用于按人数计算的费用（如团队餐费）

4. **费用项约束条件**
   - 支持为费用项配置可用性约束条件，控制费用项在特定条件下才可用
   - 复用条件组结构，支持复杂条件组合（AND/OR）
   - 支持72种常见约束场景，如天数约束、差旅类型约束、职位级别约束等
   - 提供不可用原因提示，提升用户体验

5. **时间有效性管理**
   - 支持规则的生效日期和失效日期
   - 自动过滤过期规则
   - 支持规则版本管理

6. **审批流程集成**
   - 与审批流程引擎无缝集成
   - 支持基于金额、部门、职位的动态审批流程匹配

---

## 二、架构设计

### 2.1 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端配置界面                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 标准配置管理  │  │ 条件配置管理  │  │ 费用标准配置  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 约束条件配置  │  │ 费用项管理    │  │ 动态过滤展示  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    API 服务层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 标准CRUD API │  │ 匹配查询 API  │  │ 验证检查 API  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 费用项可用性  │  │ 费用项管理API │  │ 约束条件API   │     │
│  │ 检查 API     │  │              │  │              │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   规则匹配引擎                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 条件匹配器    │  │ 优先级排序器  │  │ 规则合并器    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐                       │
│  │ 费用项可用性  │  │ 差旅数据提取器│                       │
│  │ 检查器        │  │              │                       │
│  └──────────────┘  └──────────────┘                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据存储层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ TravelStandard│ │ ExpenseItem  │  │ Location     │     │
│  │ (含约束条件)  │  │              │  │              │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Department   │  │ Position     │  │ Role         │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 差旅标准模型 (TravelStandard)

差旅标准是配置引擎的核心数据模型，包含：

- **基本信息**: 标准代码、名称、描述、版本
- **时间管理**: 生效日期、失效日期、状态
- **优先级**: 规则优先级（0-100）
- **条件组**: 多组条件，组间OR，组内AND
- **费用标准**: 关联的费用项和限额配置
- **费用项约束条件**: 费用项的可用性约束条件（可选）

#### 2.2.2 条件匹配器 (ConditionMatcher)

负责匹配差旅申请的条件与标准规则的条件：

- 支持29种条件类型：country, city, city_level, position_level, role, position, department, project_code, employee_type, organization_type, manager_level, job_category, days, trip_type, trip_purpose等
- 支持多种操作符：EQUAL, IN, NOT_IN, >=, <=, >, <, BETWEEN, CONTAINS等
- 支持条件组逻辑：OR（组间）、AND（组内）
- 复用统一匹配引擎，同时用于标准匹配和费用项约束条件匹配

#### 2.2.3 优先级排序器 (PrioritySorter)

根据规则的优先级和创建时间排序：

- 优先级高的规则优先
- 优先级相同时，创建时间新的优先

#### 2.2.4 规则合并器 (RuleMerger)

当多个规则匹配时，合并费用标准：

- **最佳匹配策略**: 选择优先级最高的规则
- **全部合并策略**: 合并所有匹配规则的费用标准

#### 2.2.5 费用项可用性检查器 (ExpenseItemAvailabilityChecker)

检查费用项在特定差旅条件下是否可用：

- 复用条件匹配器，检查费用项的约束条件
- 支持复杂条件组合（AND/OR）
- 返回可用性结果和不可用原因
- 在标准匹配时自动过滤不可用费用项

#### 2.2.6 差旅数据提取器 (TravelDataExtractor)

从差旅申请中提取匹配所需的数据：

- 提取差旅天数（根据startDate和endDate计算）
- 提取差旅类型、差旅目的等信息
- 提取总金额、住宿费总额、交通费总额等
- 提取人数、距离等扩展信息

---

## 三、数据模型设计

### 3.1 差旅标准模型 (TravelStandard)

```javascript
{
  // 基本信息
  standardCode: String,        // 标准代码（唯一）
  standardName: String,       // 标准名称
  description: String,        // 描述
  version: Number,            // 版本号
  
  // 时间管理
  effectiveDate: Date,        // 生效日期
  expiryDate: Date,           // 失效日期（可选）
  status: String,             // 状态：draft, active, expired
  
  // 优先级
  priority: Number,           // 优先级（0-100，默认50）
  
  // 条件组（核心配置）
  conditionGroups: [{
    groupId: Number,          // 组ID
    logicOperator: String,    // 组内逻辑：AND, OR
    conditions: [{
      type: String,           // 条件类型: country, city, city_level, position_level, role, position, department, project_code, employee_type, organization_type, manager_level, job_category
      operator: String,      // 操作符: EQUAL, IN, NOT_IN, >=, <=
      value: String,         // 值
      locationIds: [ObjectId] // 关联的Location ID（用于city/country）
    }]
  }],
  
  // 目标人群（兼容性字段）
  targetAudience: {
    jobLevels: [String],
    departments: [String],
    employeeTypes: [String]
  },
  
  // 费用标准配置
  expenseStandards: [{
    expenseItemId: ObjectId,  // 费用项ID
    limitType: String,        // 限额类型：FIXED, RANGE, ACTUAL, PERCENTAGE
    limitAmount: Number,      // 固定限额
    limitMin: Number,         // 最小限额
    limitMax: Number,         // 最大限额
    calcUnit: String,        // 计算单位：PER_DAY, PER_TRIP, PER_KM, PER_PERSON
    percentage: Number,      // 比例（0-100）
    baseAmount: Number,      // 基础金额
    // 费用项可用性约束条件（可选）
    availabilityConditions: {
      enabled: Boolean,      // 是否启用约束（默认false，向后兼容）
      unavailableMessage: String,  // 约束不满足时的提示信息
      conditionGroups: [{    // 条件组（复用conditionGroups结构）
        groupId: Number,
        logicOperator: String,  // 'AND' | 'OR'
        conditions: [{
          type: String,      // 条件类型
          operator: String,  // 操作符
          value: String,     // 值
          metadata: Object   // 可选：扩展字段
        }]
      }]
    }
  }],
  
  // 元数据
  createdBy: ObjectId,
  updatedBy: ObjectId,
  createdAt: Date,
  updatedAt: Date
}
```

### 3.2 支持的条件类型

| 条件类型 | 说明 | 示例值 |
|---------|------|--------|
| `country` | 国家代码 | CN, US, JP |
| `city` | 城市名称或代码 | Beijing, city032 |
| `city_level` | 城市级别 | 1, 2, 3, 4 |
| `position_level` | 职位级别 | P1, P2, P3 |
| `role` | 角色代码 | admin, manager |
| `position` | 职位代码 | Pol3000020720 |
| `department` | 部门代码 | 000023660003003 |
| `project_code` | 项目代码 | PROJ001 |
| `employee_type` | 员工类型 | 1(社招), 2(校招), 3(实习生), 4(外包) |
| `organization_type` | 组织类型 | E0005(正编), E0006(外包), E0007(临时) |
| `manager_level` | 管理级别 | manager(部门经理), deputy_manager(部门分管经理), none(无) |
| `job_category` | 职位类别 | 11(职能), 12(技术), 13(销售), 14(管理) |
| **差旅相关条件类型** | | |
| `days` | 差旅天数 | 8, 10, 15 |
| `trip_type` | 差旅类型 | domestic(国内), international(国际) |
| `trip_purpose` | 差旅目的 | meeting(会议), training(培训), project(项目), customer_visit(客户拜访) |
| `total_amount` | 差旅总金额 | 5000, 10000, 20000 |
| `accommodation_amount` | 住宿费总额 | 3000, 5000 |
| `transport_amount` | 交通费总额 | 2000, 5000 |
| `person_count` | 人数 | 2, 3, 5 |
| `distance` | 距离（公里） | 500, 1000, 2000 |
| `travel_month` | 差旅月份 | 1-12 |
| `is_weekend` | 是否包含周末 | true, false |
| `is_holiday` | 是否在节假日 | true, false |
| `travel_frequency` | 差旅频率 | high(高频), medium(中频), low(低频) |
| `consecutive_days` | 连续差旅天数 | 30, 60 |
| `has_accommodation` | 是否有住宿费 | true, false |
| `has_transport` | 是否有交通费 | true, false |
| `travel_status` | 差旅状态 | draft, submitted, approved, in-progress, completed |

**条件类型数据来源说明**：

#### 3.2.1 组织架构相关条件

- **country（国家）**：来源于 `Location` 表，查询条件 `type='country'`，使用 `countryCode` 字段（如：CN, US, JP）
- **city（城市）**：来源于 `Location` 表，查询条件 `type='city'`，使用 `name` 或 `code` 字段
- **city_level（城市级别）**：来源于 `Location` 表的 `cityLevel` 字段，或 `CityLevel` 表的 `level` 字段（1=一线城市, 2=二线城市, 3=三线城市, 4=其他）
- **department（部门）**：来源于 `Department` 表，使用 `code` 字段
- **position（职位）**：来源于 `Position` 表，使用 `code` 字段
- **position_level（职位级别）**：来源于 `JobLevel` 表的 `levelCode` 字段（如：P1, P2, P3），或 `Position` 表的 `jobLevel` 字段
- **role（角色）**：来源于 `Role` 表，使用 `code` 字段

#### 3.2.2 员工属性相关条件

- **employee_type（员工类型）**：来源于 `User` 表的 `employeeType` 字段，字典值：
  - `1`：社招人员
  - `2`：校招人员
  - `3`：实习生
  - `4`：外包人员
- **organization_type（组织类型）**：来源于 `User` 表的 `organizationType` 字段，字典值：
  - `E0005`：正编
  - `E0006`：外包
  - `E0007`：临时
- **manager_level（管理级别）**：来源于 `User` 表的 `managerLevel` 字段，字典值：
  - `manager`：部门经理
  - `deputy_manager`：部门分管经理
  - `none`：无管理级别
- **job_category（职位类别）**：来源于 `Position` 表的 `jobCategory` 字段，字典值：
  - `11`：职能
  - `12`：技术
  - `13`：销售
  - `14`：管理

#### 3.2.3 项目相关条件

- **project_code（项目代码）**：来源于项目管理系统或用户输入，格式为项目代码字符串

#### 3.2.4 差旅相关条件

- **days（差旅天数）**：从差旅申请的 `startDate` 和 `endDate` 计算得出（包含首尾两天）
- **trip_type（差旅类型）**：来源于差旅申请的 `tripType` 字段，或根据目的地国家自动判断（国内/国际）
- **trip_purpose（差旅目的）**：来源于差旅申请的 `purpose` 字段，字典值：meeting, training, project, customer_visit
- **total_amount（总金额）**：从差旅申请的 `estimatedCost` 字段，或费用预算总和计算
- **accommodation_amount（住宿费总额）**：从差旅申请的费用预算中提取住宿费相关费用项的总和
- **transport_amount（交通费总额）**：从差旅申请的费用预算中提取交通费相关费用项的总和
- **person_count（人数）**：来源于差旅申请的 `personCount` 字段或参与人数
- **distance（距离）**：从差旅申请的行程信息（outbound/inbound/multiCityRoutes）计算出发地到目的地的距离（公里）
- **travel_month（差旅月份）**：从差旅申请的 `startDate` 提取月份（1-12）
- **is_weekend（是否包含周末）**：从差旅申请的日期范围判断是否包含周六或周日
- **is_holiday（是否在节假日）**：从差旅申请的日期范围判断是否在法定节假日
- **travel_frequency（差旅频率）**：从用户历史差旅数据计算（如：月度差旅次数），字典值：high, medium, low
- **consecutive_days（连续差旅天数）**：从用户历史差旅数据计算连续差旅的总天数
- **has_accommodation（是否有住宿费）**：从差旅申请的费用预算判断是否存在住宿费相关费用项
- **has_transport（是否有交通费）**：从差旅申请的费用预算判断是否存在交通费相关费用项
- **travel_status（差旅状态）**：来源于差旅申请的 `status` 字段，字典值：draft, submitted, approved, in-progress, completed

### 3.3 支持的操作符

| 操作符 | 说明 | 适用条件类型 |
|--------|------|------------|
| `EQUAL` | 等于 | 所有类型 |
| `IN` | 在列表中 | 所有类型（值用逗号分隔） |
| `NOT_IN` | 不在列表中 | 所有类型（值用逗号分隔） |
| `>=` | 大于等于 | 数值类型（city_level, position_level, days, total_amount等） |
| `<=` | 小于等于 | 数值类型（city_level, position_level, days, total_amount等） |
| `>` | 大于 | 数值类型 |
| `<` | 小于 | 数值类型 |
| `BETWEEN` | 范围 | 数值类型（值格式：min,max） |
| `CONTAINS` | 包含 | 字符串类型 |
| `STARTS_WITH` | 以...开始 | 字符串类型 |
| `ENDS_WITH` | 以...结束 | 字符串类型 |
| `REGEX` | 正则匹配 | 字符串类型 |

### 3.4 费用限额类型

| 限额类型 | 说明 | 配置字段 | 计算规则 |
|---------|------|---------|---------|
| `FIXED` | 固定限额 | limitAmount, calcUnit | 根据计算单位计算：限额金额 × 计算单位数量 |
| `RANGE` | 范围限额 | limitMin, limitMax, calcUnit | 实际费用必须在最小值和最大值范围内 |
| `ACTUAL` | 实报实销 | 无金额限制 | 无金额限制，按实际发生费用报销 |
| `PERCENTAGE` | 按比例 | percentage, baseAmount, calcUnit | 限额 = baseAmount × (percentage / 100)，再根据计算单位计算 |

### 3.5 计算单位定义及计算规则

| 计算单位 | 代码 | 说明 | 计算公式 | 适用场景 |
|---------|------|------|---------|---------|
| **按天** | `PER_DAY` | 按差旅天数计算 | 限额金额 × 差旅天数 | 住宿费、餐费、市内交通费等 |
| **按次** | `PER_TRIP` | 按差旅单号计算（整个差旅申请只计算一次） | 限额金额 × 1 | 签证费、保险费、洗衣费等 |
| **按公里** | `PER_KM` | 按距离（公里）计算 | 限额金额 × 距离（公里） | 长途交通费、过路费等 |
| **按人** | `PER_PERSON` | 按人数计算 | 限额金额 × 人数 | 团队餐费、团队住宿费等 |

**重要说明**：

1. **差旅单号 vs 行程的区别**：
   - **差旅单号（Travel）**：一个完整的差旅申请，包含一个唯一的差旅单号（travelNumber）
   - **行程（Route/Trip）**：差旅单中的一段行程，包括：
     - 去程（outbound）：出发地到第一个目的地
     - 返程（inbound）：最后一个目的地返回出发地
     - 多程行程（multiCityRoutes）：中间的多段行程（可能有多个）

2. **按次（PER_TRIP）的定义**：
   - **按次（PER_TRIP）**：指按**差旅单号**计算，即整个差旅申请（包含去程、返程、多程行程）只计算一次
   - 如果一个差旅申请包含多个行程（去程、返程、多程），按次费用项在整个差旅单中只计算一次
   - **示例**：差旅单号TR001包含去程、返程、2个多程行程（共4个行程），洗衣费100元/次，总限额 = 100 × 1 = 100元（不是100 × 4 = 400元）

3. **适用场景**：
   - 签证费：一个差旅申请通常只需要一次签证（即使去多个国家）
   - 保险费：一个差旅申请通常只需要一次保险
   - 洗衣费：一个差旅申请通常只需要一次洗衣费
   - 其他单次发生的费用

4. **如果需要按行程计算**：
   - 如果需要按每个行程段分别计算，建议使用按天（PER_DAY）或按公里（PER_KM）等其他计算单位
   - 或者考虑新增 `PER_ROUTE` 计算单位（按行程段计算）

**计算规则说明**：

1. **固定限额（FIXED）+ 按天（PER_DAY）**
   ```
   总限额 = limitAmount × 差旅天数
   示例：住宿费 600元/天，差旅3天，总限额 = 600 × 3 = 1800元
   ```

2. **固定限额（FIXED）+ 按次（PER_TRIP）**
   ```
   总限额 = limitAmount × 1
   说明：按差旅单号计算，整个差旅申请只计算一次
   示例1：签证费 500元/次，差旅单号TR001（包含去程、返程、多程），总限额 = 500 × 1 = 500元
   示例2：洗衣费 100元/次，差旅单号TR001（无论包含多少个行程），总限额 = 100 × 1 = 100元
   注意：不随天数、行程数量变化，整个差旅申请统一计算一次
   ```

3. **固定限额（FIXED）+ 按公里（PER_KM）**
   ```
   总限额 = limitAmount × 距离（公里）
   示例：交通费 2元/公里，距离500公里，总限额 = 2 × 500 = 1000元
   注意：如果无距离信息，则使用固定金额
   ```

4. **固定限额（FIXED）+ 按人（PER_PERSON）**
   ```
   总限额 = limitAmount × 人数
   示例：团队餐费 100元/人，3人，总限额 = 100 × 3 = 300元
   ```

5. **范围限额（RANGE）+ 计算单位**
   ```
   最小限额 = limitMin × 计算单位数量
   最大限额 = limitMax × 计算单位数量
   实际费用必须在 [最小限额, 最大限额] 范围内
   示例：住宿费 300-600元/天，差旅3天，范围 = [900, 1800]元
   ```

6. **按比例（PERCENTAGE）+ 计算单位**
   ```
   基础限额 = baseAmount × (percentage / 100)
   总限额 = 基础限额 × 计算单位数量
   示例：娱乐费为差旅总费用的10%，基础金额5000元，按差旅单号计算
   基础限额 = 5000 × (10 / 100) = 500元
   总限额 = 500 × 1 = 500元（整个差旅申请只计算一次）
   ```

7. **实报实销（ACTUAL）**
   ```
   无金额限制，不进行自动计算
   实际费用 = 用户填写的实际发生金额
   ```

### 3.6 费用项约束条件

费用项约束条件用于控制费用项在特定条件下才可用，实现更精细的费用管理。

#### 3.6.1 约束条件模型

费用项约束条件复用差旅标准的条件组结构，支持灵活的条件组合：

```javascript
availabilityConditions: {
  enabled: Boolean,              // 是否启用约束（默认false）
  unavailableMessage: String,    // 约束不满足时的提示信息
  conditionGroups: [{            // 条件组（组间OR，组内AND）
    groupId: Number,
    logicOperator: String,       // 'AND' | 'OR'
    conditions: [{
      type: String,              // 条件类型
      operator: String,         // 操作符
      value: String,             // 值
      metadata: Object           // 可选：扩展字段
    }]
  }]
}
```

#### 3.6.2 常见约束场景

| 场景 | 约束条件 | 说明 |
|------|---------|------|
| 洗衣费 | 天数 >= 8天 | 只有出差天数达到8天才能使用 |
| 签证费 | 国家 != CN | 仅国际差旅可使用 |
| 国际通讯费 | 国家 != CN | 仅国际差旅可使用 |
| 部门经理招待费 | 管理级别 = manager | 仅部门经理可使用 |
| 高级酒店补贴 | 职位级别 >= P5 AND 城市级别 = 1 | 高管在一线城市 |
| 团队餐费 | 人数 >= 3人 | 团队人数达到3人 |
| 长途交通补贴 | 距离 >= 1000公里 | 距离达到1000公里 |
| 旺季住宿补贴 | 月份 IN [7,8,10] | 仅在7、8、10月 |
| 培训材料费 | 差旅目的 = training AND 天数 >= 5天 | 培训差旅且天数>=5天 |
| 大额差旅补贴 | 总金额 >= 10000元 | 差旅总金额达到10000元 |

#### 3.6.3 约束条件配置示例

约束条件配置示例详见第5.2节"费用标准配置示例"中的示例5和示例6。

#### 3.6.4 约束条件匹配逻辑

约束条件匹配复用差旅标准的条件匹配引擎：

1. **检查是否启用约束**
   - 如果 `enabled = false` 或 `availabilityConditions` 为空，费用项默认可用

2. **条件组匹配**
   - 条件组之间是OR关系：只要有一个组匹配成功，费用项就可用
   - 组内条件是AND关系：组内所有条件都必须匹配

3. **返回匹配结果**
   - `available: true` - 费用项可用
   - `available: false` - 费用项不可用，返回 `unavailableMessage`

#### 3.6.5 约束条件优势

1. **统一模型**：复用条件组结构，保持系统一致性
2. **灵活配置**：支持复杂条件组合（AND/OR）
3. **易于扩展**：新增条件类型只需扩展枚举和匹配逻辑
4. **向后兼容**：`enabled` 字段控制，默认不启用约束
5. **用户友好**：提供不可用原因提示，提升用户体验
6. **性能优化**：复用现有匹配引擎，无需重复实现

---

## 四、规则匹配引擎

### 4.1 匹配流程

```
1. 接收匹配请求
   ↓
2. 检查差旅申请状态
   - 如果状态为 submitted(已提交) 或 approved(已审批)
   - 且已保存标准版本信息（matchedStandardId）
   - 则使用已保存的标准版本，跳过重新匹配
   ↓
3. 提取匹配参数（部门、职位、国家、城市等）
   ↓
4. 提取差旅数据（天数、总金额、人数、距离等）
   ↓
5. 查询所有有效的差旅标准
   - 状态为 active
   - 生效日期 <= 当前日期
   - 失效日期 >= 当前日期 或 为空
   ↓
6. 按优先级排序（优先级降序，创建时间降序）
   ↓
7. 遍历每个标准，执行条件匹配
   ↓
8. 收集所有匹配的标准
   ↓
9. 选择合并策略
   - 最佳匹配：选择优先级最高的
   - 全部合并：合并所有匹配的标准
   ↓
10. 检查费用项约束条件
    - 遍历每个费用项
    - 检查可用性约束条件
    - 过滤不可用费用项
    ↓
11. 保存匹配的标准版本信息
    - 保存 matchedStandardId（主标准ID）
    - 保存 matchedStandardCode（标准代码）
    - 保存 matchedStandardVersion（标准版本号）
    - 保存 matchedAt（匹配时间）
    ↓
12. 返回匹配结果
    - 可用费用项列表
    - 不可用费用项列表（含原因）
    - 匹配的标准信息
```

**重要说明**：
- **已提交/已审批的差旅申请**：锁定标准版本，不再重新匹配，保持数据一致性
- **草稿状态的差旅申请**：每次编辑时重新匹配最新标准，确保使用最新规则
- **标准版本锁定机制**：通过保存 `matchedStandardId` 和 `matchedStandardVersion` 实现版本锁定

### 4.2 条件匹配算法

#### 4.2.1 条件组匹配逻辑

```javascript
function matchConditions(standard, testData) {
  // 如果没有条件组，匹配所有（无限制）
  if (!standard.conditionGroups || standard.conditionGroups.length === 0) {
    return true;
  }
  
  // 条件组之间是OR关系：只要有一个组匹配成功，标准就匹配
  for (const group of standard.conditionGroups) {
    if (matchConditionGroup(group, testData)) {
      return true;
    }
  }
  
  return false;
}
```

#### 4.2.2 组内条件匹配逻辑

```javascript
function matchConditionGroup(group, testData) {
  const { 
    country, city, cityLevel, positionLevel, department, projectCode, 
    role, position, employeeType, organizationType, managerLevel, jobCategory 
  } = testData;
  
  // 组内条件是AND关系：所有条件都必须匹配
  for (const condition of group.conditions) {
    if (!matchSingleCondition(condition, testData)) {
      return false;
    }
  }
  
  return true;
}
```

#### 4.2.3 单个条件匹配逻辑

```javascript
function matchSingleCondition(condition, testData) {
  const { type, operator, value } = condition;
  const testValue = testData[type];
  
  switch (operator) {
    case 'EQUAL':
      return testValue === value;
    
    case 'IN':
      const valueList = value.split(',').map(v => v.trim());
      return valueList.includes(testValue);
    
    case 'NOT_IN':
      const excludeList = value.split(',').map(v => v.trim());
      return !excludeList.includes(testValue);
    
    case '>=':
      return Number(testValue) >= Number(value);
    
    case '<=':
      return Number(testValue) <= Number(value);
    
    case '>':
      return Number(testValue) > Number(value);
    
    case '<':
      return Number(testValue) < Number(value);
    
    case 'BETWEEN':
      const [min, max] = value.split(',').map(v => Number(v.trim()));
      return Number(testValue) >= min && Number(testValue) <= max;
    
    case 'CONTAINS':
      return String(testValue).includes(value);
    
    case 'STARTS_WITH':
      return String(testValue).startsWith(value);
    
    case 'ENDS_WITH':
      return String(testValue).endsWith(value);
    
    default:
      return false;
  }
}
```

#### 4.2.4 费用项约束条件匹配逻辑

费用项约束条件匹配复用标准匹配的条件组匹配逻辑：

```javascript
// 检查费用项是否可用
function checkExpenseItemAvailability(expenseStandard, travelData) {
  // 如果未启用约束，默认可用
  if (!expenseStandard.availabilityConditions?.enabled) {
    return { available: true, reason: null };
  }
  
  const conditions = expenseStandard.availabilityConditions.conditionGroups;
  
  // 如果没有条件组，默认可用
  if (!conditions || conditions.length === 0) {
    return { available: true, reason: null };
  }
  
  // 使用现有的 matchConditions 函数
  const isAvailable = matchConditions(
    { conditionGroups: conditions },
    travelData
  );
  
  return {
    available: isAvailable,
    reason: isAvailable ? null : expenseStandard.availabilityConditions.unavailableMessage
  };
}

// 扩展 matchSingleCondition 支持差旅相关条件
function matchSingleCondition(condition, testData) {
  const { type, operator, value } = condition;
  const testValue = testData[type];
  
  // 现有条件类型匹配...
  
  // 新增：差旅相关条件匹配
  switch (type) {
    case 'days':
      return matchNumericCondition(testData.days, operator, value);
    
    case 'trip_type':
      return matchStringCondition(testData.tripType, operator, value);
    
    case 'trip_purpose':
      return matchStringCondition(testData.tripPurpose, operator, value);
    
    case 'total_amount':
      return matchNumericCondition(testData.totalAmount, operator, value);
    
    case 'accommodation_amount':
      return matchNumericCondition(testData.accommodationAmount, operator, value);
    
    case 'transport_amount':
      return matchNumericCondition(testData.transportAmount, operator, value);
    
    case 'person_count':
      return matchNumericCondition(testData.personCount, operator, value);
    
    case 'distance':
      return matchNumericCondition(testData.distance, operator, value);
    
    case 'travel_month':
      return matchNumericCondition(testData.travelMonth, operator, value);
    
    case 'is_weekend':
      return matchBooleanCondition(testData.isWeekend, operator, value);
    
    case 'is_holiday':
      return matchBooleanCondition(testData.isHoliday, operator, value);
    
    case 'travel_frequency':
      return matchStringCondition(testData.travelFrequency, operator, value);
    
    case 'consecutive_days':
      return matchNumericCondition(testData.consecutiveDays, operator, value);
    
    case 'has_accommodation':
      return matchBooleanCondition(testData.hasAccommodation, operator, value);
    
    case 'has_transport':
      return matchBooleanCondition(testData.hasTransport, operator, value);
    
    case 'travel_status':
      return matchStringCondition(testData.travelStatus, operator, value);
    
    default:
      return false;
  }
}
```

### 4.3 规则合并策略

#### 4.3.1 最佳匹配策略 (Best Match)

选择优先级最高的匹配规则，直接使用其费用标准。

**适用场景**:
- 规则之间互斥
- 只需要一个明确的费用标准

**示例**:
```javascript
// 匹配到3个规则，优先级分别为：80, 60, 50
// 选择优先级80的规则
primaryStandard = matchedStandards[0]; // priority: 80
```

#### 4.3.2 全部合并策略 (Merge All)

合并所有匹配规则的费用标准，取最严格的限额。

**适用场景**:
- 规则可以叠加
- 需要综合考虑多个规则的限制

**合并规则**:
- 相同费用项：取最小值（最严格）
- 不同费用项：合并所有
- 实报实销类型：保留实报实销

**示例**:
```javascript
// 规则1: 住宿费 600元/天
// 规则2: 住宿费 500元/天
// 合并结果: 住宿费 500元/天（取最小值）
```

---

## 五、配置示例

### 5.1 基础配置示例

#### 示例1: 部门+职位+国家的组合条件

```json
{
  "standardCode": "STD_DEPT001_POS001_CN",
  "standardName": "研发部-高级工程师-国内差旅标准",
  "description": "适用于研发部高级工程师的国内差旅",
  "effectiveDate": "2025-01-01T00:00:00.000Z",
  "status": "active",
  "priority": 80,
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "department",
          "operator": "EQUAL",
          "value": "DEPT001"
        },
        {
          "type": "position",
          "operator": "EQUAL",
          "value": "POS001"
        },
        {
          "type": "country",
          "operator": "EQUAL",
          "value": "CN"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 600,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

#### 示例2: 多条件组（OR逻辑）

```json
{
  "standardCode": "STD_MULTI_CONDITION",
  "standardName": "多条件差旅标准",
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "department",
          "operator": "EQUAL",
          "value": "DEPT001"
        },
        {
          "type": "city_level",
          "operator": ">=",
          "value": "2"
        }
      ]
    },
    {
      "groupId": 2,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "role",
          "operator": "EQUAL",
          "value": "admin"
        },
        {
          "type": "country",
          "operator": "NOT_IN",
          "value": "CN"
        }
      ]
    }
  ]
}
```

**匹配逻辑**: 
- 条件组1匹配：部门=DEPT001 AND 城市级别>=2
- **OR**
- 条件组2匹配：角色=admin AND 国家≠CN
- 只要满足任一条件组，标准就匹配

#### 示例3: 城市列表匹配（IN操作符）

```json
{
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "city",
          "operator": "IN",
          "value": "Beijing, Shanghai, Guangzhou, Shenzhen"
        },
        {
          "type": "city_level",
          "operator": "EQUAL",
          "value": "1"
        }
      ]
    }
  ]
}
```

**匹配逻辑**: 城市在北京、上海、广州、深圳之一，且城市级别为1

### 5.2 费用标准配置示例

#### 示例1: 固定限额

```json
{
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_meal",
      "limitType": "FIXED",
      "limitAmount": 230,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 餐费固定230元/天

#### 示例2: 范围限额

```json
{
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "RANGE",
      "limitMin": 300,
      "limitMax": 600,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 住宿费在300-600元/天范围内

#### 示例3: 实报实销

```json
{
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_visa",
      "limitType": "ACTUAL"
    }
  ]
}
```

**说明**: 签证费实报实销，无金额限制（按差旅单号计算）

#### 示例4: 按比例

```json
{
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_entertainment",
      "limitType": "PERCENTAGE",
      "percentage": 10,
      "baseAmount": 5000,
      "calcUnit": "PER_TRIP"
    }
  ]
}
```

**说明**: 娱乐费为差旅总费用的10%，基础金额5000元，按差旅单号计算（整个差旅申请只计算一次）

#### 示例5: 带约束条件的费用项（洗衣费）

```json
{
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_laundry",
      "expenseItemName": "洗衣费",
      "limitType": "FIXED",
      "limitAmount": 100,
      "calcUnit": "PER_TRIP",
      "availabilityConditions": {
        "enabled": true,
        "unavailableMessage": "差旅天数不足8天，无法使用洗衣费",
        "conditionGroups": [
          {
            "groupId": 1,
            "logicOperator": "AND",
            "conditions": [
              {
                "type": "days",
                "operator": ">=",
                "value": "8"
              }
            ]
          }
        ]
      }
    }
  ]
}
```

**说明**: 洗衣费固定100元/次（按差旅单号计算），但只有差旅天数≥8天时才能使用

#### 示例6: 组合约束条件（国际差旅洗衣费）

```json
{
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_international_laundry",
      "expenseItemName": "国际差旅洗衣费",
      "limitType": "FIXED",
      "limitAmount": 150,
      "calcUnit": "PER_TRIP",
      "availabilityConditions": {
        "enabled": true,
        "unavailableMessage": "需国际差旅且天数≥8天",
        "conditionGroups": [
          {
            "groupId": 1,
            "logicOperator": "AND",
            "conditions": [
              {
                "type": "country",
                "operator": "NOT_IN",
                "value": "CN"
              },
              {
                "type": "days",
                "operator": ">=",
                "value": "8"
              }
            ]
          }
        ]
      }
    }
  ]
}
```

**说明**: 国际差旅洗衣费150元/次（按差旅单号计算），需同时满足：国家≠中国 AND 天数≥8天

### 5.3 复杂场景配置示例

#### 场景1: 按城市级别差异化配置

```json
{
  "standardCode": "STD_CITY_LEVEL_BASED",
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "city_level",
          "operator": "EQUAL",
          "value": "1"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 600,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 1级城市住宿费600元/天

需要为不同城市级别创建不同的标准，通过优先级控制匹配顺序。

#### 场景2: 项目代码特殊规则

```json
{
  "standardCode": "STD_PROJECT_SPECIAL",
  "priority": 90,
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "project_code",
          "operator": "EQUAL",
          "value": "PROJ_SPECIAL_001"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 800,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 特定项目（PROJ_SPECIAL_001）的住宿费标准为800元/天，优先级90，优先于通用规则

#### 场景3: 员工类型和组织类型组合配置

```json
{
  "standardCode": "STD_FULLTIME_REGULAR",
  "standardName": "正编社招员工差旅标准",
  "description": "适用于正编社招员工的差旅标准",
  "priority": 75,
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "employee_type",
          "operator": "EQUAL",
          "value": "1"
        },
        {
          "type": "organization_type",
          "operator": "EQUAL",
          "value": "E0005"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 600,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 员工类型为社招（1）且组织类型为正编（E0005）的员工，住宿费600元/天

#### 场景4: 管理级别差异化配置

```json
{
  "standardCode": "STD_MANAGER_LEVEL",
  "standardName": "部门经理差旅标准",
  "description": "适用于部门经理的差旅标准，享受更高标准",
  "priority": 85,
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "manager_level",
          "operator": "IN",
          "value": "manager, deputy_manager"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 800,
      "calcUnit": "PER_DAY"
    },
    {
      "expenseItemId": "expense_item_meal",
      "limitType": "FIXED",
      "limitAmount": 300,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 部门经理或部门分管经理，住宿费800元/天，餐费300元/天

#### 场景5: 职位类别差异化配置

```json
{
  "standardCode": "STD_TECHNICAL_ROLE",
  "standardName": "技术类职位差旅标准",
  "description": "适用于技术类职位的差旅标准",
  "priority": 70,
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "job_category",
          "operator": "EQUAL",
          "value": "12"
        },
        {
          "type": "country",
          "operator": "EQUAL",
          "value": "CN"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 550,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 职位类别为技术类（12）且国内差旅，住宿费550元/天

#### 场景6: 多维度组合配置

```json
{
  "standardCode": "STD_COMPLEX_MULTI_DIMENSION",
  "standardName": "多维度组合差旅标准",
  "description": "适用于正编社招技术类部门经理的差旅标准",
  "priority": 90,
  "conditionGroups": [
    {
      "groupId": 1,
      "logicOperator": "AND",
      "conditions": [
        {
          "type": "employee_type",
          "operator": "EQUAL",
          "value": "1"
        },
        {
          "type": "organization_type",
          "operator": "EQUAL",
          "value": "E0005"
        },
        {
          "type": "job_category",
          "operator": "EQUAL",
          "value": "12"
        },
        {
          "type": "manager_level",
          "operator": "EQUAL",
          "value": "manager"
        },
        {
          "type": "city_level",
          "operator": ">=",
          "value": "1"
        }
      ]
    }
  ],
  "expenseStandards": [
    {
      "expenseItemId": "expense_item_accommodation",
      "limitType": "FIXED",
      "limitAmount": 900,
      "calcUnit": "PER_DAY"
    }
  ]
}
```

**说明**: 正编社招技术类部门经理，在1级及以上城市差旅，住宿费900元/天

---

## 六、API接口设计

### 6.1 差旅申请标准版本锁定机制

差旅申请在匹配标准时，会根据申请状态决定是否锁定标准版本：

| 差旅申请状态 | 标准版本处理 | 说明 |
|------------|------------|------|
| `draft`（草稿） | 每次编辑重新匹配 | 编辑时重新匹配最新标准，确保使用最新规则 |
| `submitted`（已提交） | 锁定标准版本 | 保存匹配的标准版本信息，不再重新匹配 |
| `approved`（已审批） | 锁定标准版本 | 保存匹配的标准版本信息，不再重新匹配 |
| `in-progress`（进行中） | 锁定标准版本 | 保存匹配的标准版本信息，不再重新匹配 |
| `completed`（已完成） | 锁定标准版本 | 保存匹配的标准版本信息，不再重新匹配 |

**差旅申请模型扩展字段**（用于保存标准版本信息）：
```javascript
{
  // 标准版本信息（用于版本锁定）
  matchedStandardId: ObjectId,        // 匹配的标准ID
  matchedStandardCode: String,        // 标准代码
  matchedStandardVersion: Number,     // 标准版本号
  matchedAt: Date,                    // 匹配时间
  matchStrategy: String,              // 匹配策略（PRIORITY, MERGE_BEST, MERGE_ALL）
  matchedExpenses: Object,            // 匹配时的费用项快照（可选）
}
```

**匹配逻辑**：
1. 检查差旅申请状态和 `matchedStandardId`
2. 如果状态为 `submitted`/`approved`/`in-progress`/`completed` 且存在 `matchedStandardId`，则使用已保存的标准版本
3. 如果状态为 `draft` 或不存在 `matchedStandardId`，则重新匹配最新标准
4. 匹配成功后，保存标准版本信息到差旅申请

**版本管理机制**：

1. **标准版本号生成规则**
   - 标准创建时，版本号从1开始（`version: 1`）
   - 标准更新时，版本号自动递增（`version: version + 1`）
   - 版本号不可回退，确保版本历史可追溯
   - 版本号与标准ID绑定，同一标准代码的不同版本共享版本号序列

2. **版本锁定时机**
   - **草稿状态（draft）**：不锁定版本，每次编辑时重新匹配最新标准
   - **已提交状态（submitted）**：提交时锁定版本，保存匹配的标准版本信息
   - **已审批状态（approved）**：审批时锁定版本（如果提交时未锁定）
   - **进行中状态（in-progress）**：开始差旅时锁定版本（如果之前未锁定）
   - **已完成状态（completed）**：完成差旅时锁定版本（如果之前未锁定）

3. **版本信息保存**
   - 匹配成功时，保存以下版本信息到差旅申请：
     - `matchedStandardId`：匹配的标准ID（ObjectId）
     - `matchedStandardCode`：标准代码（String）
     - `matchedStandardVersion`：标准版本号（Number）
     - `matchedAt`：匹配时间戳（Date）
     - `matchStrategy`：使用的匹配策略（String）
     - `matchedExpenses`：匹配时的费用项快照（Object，可选）

4. **版本更新影响**
   - **已锁定版本的差旅申请**：不受标准更新影响，继续使用锁定时的标准版本
   - **草稿状态的差旅申请**：标准更新后，下次编辑时会自动匹配到新版本
   - **标准删除**：已锁定版本的差旅申请不受影响，但无法查看标准详情
   - **标准失效**：已锁定版本的差旅申请不受影响，继续使用锁定时的标准

5. **版本查询和追溯**
   - 通过 `matchedStandardId` 和 `matchedStandardVersion` 可以查询到匹配时的标准详情
   - 支持查看历史版本的标准配置（如果系统保留版本历史）
   - 审计日志记录版本匹配和锁定操作

6. **版本兼容性处理**
   - 如果锁定的标准版本已被删除，系统应保留版本信息，但标记为标准已删除
   - 如果锁定的标准版本已失效，系统应保留版本信息，但标记为标准已失效
   - 前端显示时，应提示用户标准版本已删除或失效，但保留历史数据

### 6.2 标准匹配API

| API路径 | 请求方法 | 功能描述 |
|--------|---------|---------|
| `/api/travel-standards/match` | POST | 根据条件匹配差旅标准，返回匹配的标准和费用项列表 |

**请求参数示例**:
```json
{
  "country": "CN",
  "city": "Beijing",
  "cityLevel": 1,
  "positionLevel": "P3",
  "department": "DEPT001",
  "position": "POS001",
  "role": "engineer",
  "projectCode": "PROJ001",
  "employeeType": "1",
  "organizationType": "E0005",
  "managerLevel": "none",
  "jobCategory": "11",
  "days": 10,
  "tripType": "domestic",
  "tripPurpose": "meeting",
  "totalAmount": 5000,
  "personCount": 1,
  "distance": 800,
  "currency": "CNY",
  "matchStrategy": "MERGE_BEST"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "primaryStandard": {
      "standardCode": "STD_DEPT001_POS001_CN",
      "standardName": "研发部-高级工程师-国内差旅标准",
      "priority": 80
    },
    "matchedCount": 1,
    "expenses": [
      {
        "expenseItemId": "expense_item_accommodation",
        "expenseItemName": "住宿费",
        "limitType": "FIXED",
        "limitAmount": 600,
        "calcUnit": "PER_DAY",
        "currency": "CNY",
        "available": true
      },
      {
        "expenseItemId": "expense_item_laundry",
        "expenseItemName": "洗衣费",
        "limitType": "FIXED",
        "limitAmount": 100,
        "calcUnit": "PER_TRIP",
        "currency": "CNY",
        "available": true
      }
    ],
    "unavailableExpenses": [
      {
        "expenseItemId": "expense_item_visa",
        "expenseItemName": "签证费",
        "reason": "仅国际差旅可使用签证费"
      }
    ],
    "allMatchedStandards": [
      {
        "standardCode": "STD_DEPT001_POS001_CN",
        "standardName": "研发部-高级工程师-国内差旅标准",
        "priority": 80
      }
    ]
  }
}
```

**异常处理**：

| 异常场景 | HTTP状态码 | 错误码 | 错误信息 | 处理方式 |
|---------|----------|--------|---------|---------|
| **匹配失败（无匹配标准）** | 200 | `NO_MATCHING_STANDARD` | "未找到匹配的差旅标准，请检查条件或配置默认标准" | 返回空结果，提示用户配置默认标准或检查条件 |
| **标准不存在** | 404 | `STANDARD_NOT_FOUND` | "标准不存在或已被删除" | 检查标准ID是否存在，如不存在则返回错误 |
| **费用项不存在** | 200 | `EXPENSE_ITEM_NOT_FOUND` | "费用项不存在或已被删除" | 在费用项列表中标记为无效，但不影响其他费用项 |
| **标准已失效** | 200 | `STANDARD_EXPIRED` | "标准已失效，请使用最新标准" | 如果使用锁定版本，允许使用；如果是新匹配，返回错误 |
| **标准已删除** | 404 | `STANDARD_DELETED` | "标准已被删除" | 如果使用锁定版本，保留版本信息但标记为已删除 |
| **参数验证失败** | 400 | `INVALID_PARAMETER` | "请求参数格式错误：{具体错误信息}" | 返回参数验证错误详情 |
| **锁定版本不匹配** | 200 | `VERSION_MISMATCH` | "锁定的标准版本不存在，已重新匹配最新标准" | 自动重新匹配最新标准，更新版本信息 |
| **费用项约束条件错误** | 200 | `CONSTRAINT_ERROR` | "费用项约束条件配置错误：{具体错误}" | 记录错误日志，该费用项标记为不可用 |
| **数据库连接失败** | 500 | `DATABASE_ERROR` | "数据库连接失败，请稍后重试" | 返回服务器错误，记录日志 |
| **权限不足** | 403 | `PERMISSION_DENIED` | "无权限访问该标准" | 检查用户权限，返回权限错误 |

**异常响应格式**：
```json
{
  "success": false,
  "error": {
    "code": "NO_MATCHING_STANDARD",
    "message": "未找到匹配的差旅标准，请检查条件或配置默认标准",
    "details": {
      "matchedConditions": {
        "department": "DEPT001",
        "country": "CN"
      },
      "suggestion": "建议配置默认标准（优先级0）或检查条件配置"
    }
  }
}
```

**异常处理策略**：

1. **匹配失败处理**
   - 如果未找到匹配标准，返回空结果（`matchedCount: 0`）
   - 建议配置默认标准（优先级0），作为兜底规则
   - 记录匹配失败日志，包含匹配条件和失败原因

2. **标准不存在处理**
   - 如果使用锁定版本但标准已删除，保留版本信息，标记为标准已删除
   - 如果新匹配时标准不存在，返回错误，提示用户检查标准配置
   - 记录标准删除操作日志

3. **费用项不存在处理**
   - 如果标准中引用的费用项不存在，该费用项不返回，但不影响其他费用项
   - 记录费用项缺失警告日志
   - 建议在标准配置时验证费用项是否存在

4. **版本锁定异常处理**
   - 如果锁定的标准版本不存在，自动重新匹配最新标准
   - 更新差旅申请的版本信息
   - 记录版本不匹配日志

5. **参数验证处理**
   - 请求参数格式验证失败，返回400错误
   - 提供详细的参数错误信息，便于前端显示
   - 必填参数缺失时，明确提示缺失的参数

6. **约束条件错误处理**
   - 费用项约束条件配置错误时，该费用项标记为不可用
   - 返回不可用原因，但不影响其他费用项
   - 记录约束条件错误日志，便于管理员修复

### 6.3 标准管理API

| API路径 | 请求方法 | 功能描述 |
|--------|---------|---------|
| `/api/travel-standards` | GET | 获取所有差旅标准列表，支持分页和筛选 |
| `/api/travel-standards/:id` | GET | 获取指定差旅标准详情 |
| `/api/travel-standards` | POST | 创建新的差旅标准 |
| `/api/travel-standards/:id` | PUT | 更新差旅标准 |
| `/api/travel-standards/:id` | DELETE | 删除差旅标准 |

### 6.4 费用项管理API

费用项管理提供独立的API接口，支持动态新增、编辑和删除费用项：

| API路径 | 请求方法 | 功能描述 |
|--------|---------|---------|
| `/api/expense-items` | GET | 获取所有费用项列表，支持分页和筛选 |
| `/api/expense-items/:id` | GET | 获取指定费用项详情 |
| `/api/expense-items` | POST | 创建新的费用项 |
| `/api/expense-items/item/:id` | PUT | 更新费用项 |
| `/api/expense-items/item/:id` | DELETE | 删除费用项 |

**说明**: 费用项创建后，可在差旅标准配置中选择该费用项并设置限额规则。

### 6.5 费用项可用性检查API

| API路径 | 请求方法 | 功能描述 |
|--------|---------|---------|
| `/api/expense-items/check-availability` | POST | 检查费用项在特定差旅条件下是否可用，返回可用性结果和不可用原因 |

**请求参数示例**:
```json
{
  "expenseItemId": "expense_item_laundry",
  "travel": {
    "days": 7,
    "country": "CN",
    "city": "Beijing",
    "tripType": "domestic",
    "totalAmount": 5000
  }
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "available": false,
    "reason": "差旅天数不足8天，无法使用洗衣费",
    "expenseItem": {
      "expenseItemId": "expense_item_laundry",
      "expenseItemName": "洗衣费"
    }
  }
}
```

---

## 七、扩展性设计

### 7.1 添加新的条件类型

**步骤**:
1. 在 `TravelStandard` 模型的 `conditionGroups.conditions.type` enum 中添加新类型
2. 在 `matchSingleCondition` 函数中添加对应的匹配逻辑
3. 更新前端配置界面，支持新条件类型的选择

**示例**: 添加 `employee_type` 条件类型（已实现）
```javascript
// 1. 更新模型
type: {
  enum: [
    'country', 'city', 'city_level', 'position_level', 'role', 'position', 
    'department', 'project_code', 'employee_type', 'organization_type', 
    'manager_level', 'job_category'
  ]
}

// 2. 更新匹配逻辑
case 'employee_type':
  return testData.employeeType === value;

case 'organization_type':
  return testData.organizationType === value;

case 'manager_level':
  return testData.managerLevel === value;

case 'job_category':
  return testData.jobCategory === value;
```

### 7.2 添加新的操作符

**步骤**:
1. 在 `TravelStandard` 模型的 `conditionGroups.conditions.operator` enum 中添加新操作符
2. 在 `matchSingleCondition` 函数中添加对应的匹配逻辑

**示例**: 添加 `CONTAINS` 操作符（包含）
```javascript
case 'CONTAINS':
  return testValue.includes(value);
```

### 7.3 添加新的费用限额类型

**步骤**:
1. 在 `TravelStandard` 模型的 `expenseStandards.limitType` enum 中添加新类型
2. 更新费用验证逻辑，支持新类型的限额检查
3. 更新前端配置界面

**示例**: 添加 `DAILY_MAX` 类型（每日上限）
```javascript
limitType: {
  enum: ['FIXED', 'RANGE', 'ACTUAL', 'PERCENTAGE', 'DAILY_MAX']
}
```

### 7.4 自定义合并策略

**步骤**:
1. 在匹配API中添加 `mergeStrategy` 参数
2. 实现自定义合并函数
3. 在匹配结果中应用合并策略

**示例**: 添加 `AVERAGE` 合并策略（取平均值）
```javascript
function mergeExpensesAverage(standards, targetCurrency) {
  // 计算所有匹配标准的费用平均值
  // ...
}
```

### 7.5 添加费用项约束条件

费用项约束条件复用差旅标准的条件组结构，扩展非常简单：

**步骤**:
1. 在 `expenseStandards` 中增加 `availabilityConditions` 字段（可选）
2. 扩展条件类型枚举，支持差旅相关条件（如 `days`, `trip_type` 等）
3. 扩展匹配逻辑，支持差旅相关条件的匹配
4. 在标准匹配API中过滤可用费用项
5. 前端动态过滤并显示不可用原因

**示例**: 添加 `days` 条件类型支持

```javascript
// 1. 扩展条件类型枚举
type: {
  enum: [
    // ... 现有类型
    'days', 'trip_type', 'trip_purpose', 'total_amount', 
    'person_count', 'distance', 'travel_month' // 等
  ]
}

// 2. 扩展匹配逻辑
case 'days':
  return matchNumericCondition(testData.days, operator, value);

case 'trip_type':
  return matchStringCondition(testData.tripType, operator, value);

// 3. 在标准匹配时检查费用项可用性
const availableExpenses = expenses.filter(expense => {
  const availability = checkExpenseItemAvailability(expense, travelData);
  return availability.available;
});
```

**配置示例**: 详见第5.2节"费用标准配置示例"中的示例5和示例6。

---

## 八、性能优化

### 8.1 索引优化

```javascript
// TravelStandard 模型索引
TravelStandardSchema.index({ status: 1, effectiveDate: 1, expiryDate: 1 });
TravelStandardSchema.index({ priority: -1 });
TravelStandardSchema.index({ 'conditionGroups.conditions.type': 1 });
TravelStandardSchema.index({ 'conditionGroups.conditions.value': 1 });
```

### 8.2 查询优化

1. **预过滤**: 先查询状态为active、日期有效的标准
2. **排序优化**: 使用数据库索引排序，避免内存排序
3. **早期退出**: 找到优先级最高的匹配标准后，可以提前退出（如果使用最佳匹配策略）

### 8.3 缓存策略

1. **规则缓存**: 缓存活跃的差旅标准列表（TTL: 5分钟）
2. **匹配结果缓存**: 缓存常见条件的匹配结果（TTL: 1分钟）
3. **缓存失效**: 标准更新时清除相关缓存

---

## 九、最佳实践

### 9.1 规则设计原则

1. **优先级设置**
   - 通用规则：优先级 50（默认）
   - 部门规则：优先级 60-70
   - 职位规则：优先级 70-80
   - 特殊规则：优先级 80-100

2. **条件组设计**
   - 尽量使用条件组（OR逻辑）而不是创建多个标准
   - 组内条件尽量精简，避免过度复杂

3. **规则粒度**
   - 不要创建过于细粒度的规则（如：每个员工一个规则）
   - 使用条件组合实现灵活的匹配

### 9.2 配置管理建议

1. **版本控制**
   - 规则更新时创建新版本，保留旧版本历史
   - 使用生效日期和失效日期管理规则生命周期

2. **过程数据处理**
   - **已提交/已审批的差旅申请**：锁定标准版本，不再重新匹配
     - 已提交（submitted）或已审批（approved）状态的差旅申请，保存匹配的标准版本信息
     - 后续查看或审批时，使用保存的标准版本，不受标准更新影响
     - 确保历史数据的一致性和可追溯性
   - **草稿状态的差旅申请**：编辑时重新匹配最新标准
     - 草稿（draft）状态的差旅申请，每次编辑时重新匹配最新标准
     - 确保使用最新的标准规则和费用限额
     - 用户可以看到最新的标准变化
   - **标准版本信息保存**
     - 保存 `matchedStandardId`：匹配的标准ID
     - 保存 `matchedStandardCode`：标准代码
     - 保存 `matchedStandardVersion`：标准版本号
     - 保存 `matchedAt`：匹配时间戳
     - 保存 `matchStrategy`：使用的匹配策略

3. **测试验证**
   - 配置新规则后，使用测试用例验证匹配逻辑
   - 检查规则冲突和优先级设置
   - 测试已提交申请的版本锁定机制
   - 测试草稿申请重新匹配逻辑

4. **文档记录**
   - 为每个标准添加清晰的描述
   - 记录规则的业务背景和适用范围
   - 记录标准更新的影响范围和时间点

### 9.3 费用项约束条件配置建议

1. **约束条件设计原则**
   - 优先使用简单条件：单个条件比组合条件更易理解和维护
   - 合理使用条件组：避免过度复杂的条件组合
   - 提供清晰的提示信息：`unavailableMessage` 要明确说明不可用原因

2. **常见约束场景配置**
   - **天数约束**：使用 `days` 条件类型，适用于洗衣费、长期住宿补贴等
   - **差旅类型约束**：使用 `country` 或 `trip_type` 条件，适用于签证费、国际通讯费等
   - **职位级别约束**：使用 `position_level` 或 `manager_level`，适用于高级职位特殊费用
   - **组合约束**：使用条件组组合多个条件，适用于复杂业务场景

3. **约束条件测试**
   - 测试边界条件：如天数=7天（不可用）和天数=8天（可用）
   - 测试组合条件：确保AND/OR逻辑正确
   - 测试向后兼容：确保未启用约束的费用项正常工作

### 9.4 常见问题处理

1. **规则冲突**
   - 使用优先级解决冲突
   - 定期审查规则，避免重复和冲突

2. **匹配失败**
   - 提供默认规则（优先级0）作为兜底规则
   - 记录匹配失败的日志，包含匹配条件和失败原因
   - 返回友好的错误提示，建议用户检查条件配置或联系管理员
   - 如果未找到匹配标准，返回空结果（`matchedCount: 0`），不影响其他功能

3. **费用项不可用**
   - 检查约束条件是否正确配置
   - 验证差旅数据是否满足约束条件
   - 查看 `unavailableMessage` 了解具体原因

4. **性能问题**
   - 控制规则数量（建议 < 1000条）
   - 使用索引优化查询
   - 考虑规则分组和分层
   - 约束条件匹配计算量小，性能影响可忽略

---

## 十、配置检查清单

### 10.1 标准配置检查

- [ ] 标准代码唯一且符合命名规范
- [ ] 标准名称清晰描述适用范围
- [ ] 生效日期和失效日期设置正确
- [ ] 优先级设置合理（0-100）
- [ ] 状态设置为 active（生效时）

### 10.2 条件配置检查

- [ ] 条件组逻辑正确（组间OR，组内AND）
- [ ] 条件类型和操作符选择正确
- [ ] 条件值格式正确（IN操作符的值用逗号分隔）
- [ ] 至少有一个条件组或条件

### 10.3 费用标准检查

- [ ] 费用项ID有效
- [ ] 限额类型和配置字段匹配
- [ ] 金额值合理（> 0）
- [ ] 计算单位选择正确
- [ ] 费用项约束条件配置正确（如启用）
- [ ] 约束条件类型和操作符选择正确
- [ ] 约束条件值格式正确
- [ ] 不可用提示信息清晰明确

### 10.4 测试验证

- [ ] 使用测试用例验证匹配逻辑
- [ ] 验证优先级排序正确
- [ ] 验证费用标准合并正确
- [ ] 验证边界条件（无匹配、多匹配）
- [ ] 验证费用项约束条件匹配正确
- [ ] 测试约束条件边界值（如天数=7天不可用，8天可用）
- [ ] 测试组合约束条件（AND/OR逻辑）
- [ ] 验证不可用费用项的提示信息显示正确

---

## 十一、前端页面设计

### 11.1 差旅标准配置表单页面

差旅标准配置采用分步表单设计，包含4个步骤：基本信息、条件配置、费用标准配置、预览确认。

#### 11.1.1 基本信息配置页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 标准代码 | 文本输入框 | 大写字母、数字、下划线，长度3-50字符 | 自动转换为大写，编辑模式下禁用 | 必填，唯一，编辑时不可修改 | - |
| 标准名称 | 文本输入框 | 长度1-200字符 | 用户输入标准名称 | 必填 | - |
| 描述 | 多行文本输入框 | 长度0-1000字符 | 用户输入描述信息 | 选填 | - |
| 生效日期 | 日期选择器 | 日期格式（YYYY-MM-DD） | 选择生效日期，不能早于当前日期 | 必填 | 当前日期 |
| 失效日期 | 日期选择器 | 日期格式（YYYY-MM-DD）或空 | 选择失效日期，必须晚于生效日期 | 选填 | 空 |
| 状态 | 下拉选择 | 字典项: draft(草稿), active(生效), expired(已过期) | 选择标准状态，新建时默认为草稿 | 必填 | draft |
| 优先级 | 数字输入框 | 0-100的整数 | 输入优先级数值，数值越大优先级越高 | 必填，范围0-100 | 50 |

#### 11.1.2 条件配置页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 条件组列表 | 动态列表 | 可添加多个条件组 | 支持添加、删除条件组，条件组之间是OR关系 | 至少需要一个条件组 | 空列表 |
| 条件组内逻辑 | 下拉选择 | 字典项: AND, OR | 选择组内条件的逻辑关系 | 必填 | AND |
| 条件类型 | 下拉选择 | 字典项: country(国家), city(城市), city_level(城市级别), position_level(职位级别), role(角色), position(职位), department(部门), project_code(项目代码), employee_type(员工类型), organization_type(组织类型), manager_level(管理级别), job_category(职位类别) | 选择条件类型，用于匹配差旅申请 | 必填 | - |
| 操作符 | 下拉选择 | 字典项: EQUAL(等于), IN(在列表中), NOT_IN(不在列表中), >=(大于等于), <=(小于等于), >(大于), <(小于), BETWEEN(范围) | 选择操作符，根据条件类型动态显示可用操作符 | 必填 | EQUAL |
| 条件值 | 文本输入框或下拉选择 | 根据条件类型确定数据来源：<br/>- country: 从Location API获取国家列表（countryCode）<br/>- city: 从Location API获取城市列表（name或code）<br/>- city_level: 字典值（1,2,3,4）<br/>- position_level: 从JobLevel API获取职位级别列表（levelCode）<br/>- role: 从Role API获取角色列表（code）<br/>- position: 从Position API获取职位列表（code）<br/>- department: 从Department API获取部门列表（code）<br/>- project_code: 文本输入或从项目API获取<br/>- employee_type: 字典值（1,2,3,4）<br/>- organization_type: 字典值（E0005,E0006,E0007）<br/>- manager_level: 字典值（manager,deputy_manager,none）<br/>- job_category: 字典值（11,12,13,14） | 根据条件类型从对应数据源选择或输入条件值，IN/NOT_IN操作符支持多值（逗号分隔） | 必填 | - |
| 添加条件 | 按钮 | - | 在当前条件组中添加新条件 | - | - |
| 删除条件 | 按钮 | - | 删除当前条件 | 至少保留一个条件 | - |

#### 11.1.3 费用标准配置页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 费用项列表 | 动态列表 | 从费用项管理模块获取 | 支持添加、删除费用项，每个费用项可配置限额 | 至少需要一个费用项 | 空列表 |
| 费用项选择 | 下拉选择 | 从费用项管理API获取的费用项列表 | 选择要配置的费用项，已选择的费用项不可重复选择 | 必填 | - |
| 限额类型 | 下拉选择 | 字典项: FIXED(固定限额), RANGE(范围限额), ACTUAL(实报实销), PERCENTAGE(按比例) | 选择限额类型，根据类型显示不同的配置字段 | 必填 | FIXED |
| 固定限额金额 | 数字输入框 | 大于0的数字，最多2位小数 | 输入固定限额金额 | 限额类型为FIXED时必填 | - |
| 最小限额 | 数字输入框 | 大于0的数字，最多2位小数 | 输入最小限额金额 | 限额类型为RANGE时必填 | - |
| 最大限额 | 数字输入框 | 大于最小限额的数字，最多2位小数 | 输入最大限额金额 | 限额类型为RANGE时必填 | - |
| 基础金额 | 数字输入框 | 大于0的数字，最多2位小数 | 输入基础金额，用于按比例计算 | 限额类型为PERCENTAGE时必填 | - |
| 比例 | 数字输入框 | 0-100的数字，最多2位小数 | 输入百分比 | 限额类型为PERCENTAGE时必填 | - |
| 计算单位 | 下拉选择 | 字典项: PER_DAY(按天), PER_TRIP(按次), PER_KM(按公里), PER_PERSON(按人) | 选择计算单位，用于计算总限额 | 限额类型不为ACTUAL时必填 | PER_DAY |
| 启用约束条件 | 开关 | true/false | 启用或禁用费用项的约束条件 | 选填 | false |
| 约束条件组 | 动态列表 | 复用条件配置页面的条件组结构 | 配置费用项的可用性约束条件 | 启用约束条件时必填 | 空列表 |
| 不可用提示信息 | 文本输入框 | 长度1-200字符 | 输入约束条件不满足时的提示信息 | 启用约束条件时必填 | - |
| 添加费用项 | 按钮 | - | 添加新的费用项配置 | - | - |
| 删除费用项 | 按钮 | - | 删除当前费用项配置 | 至少保留一个费用项 | - |

#### 11.1.4 预览确认页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 基本信息预览 | 只读展示 | 显示已配置的基本信息 | 展示标准代码、名称、描述、日期、状态、优先级 | - | - |
| 条件配置预览 | 只读展示 | 显示已配置的条件组和条件 | 展示所有条件组及其条件，显示匹配逻辑 | - | - |
| 费用标准预览 | 只读展示 | 显示已配置的费用项和限额 | 展示所有费用项及其限额配置、约束条件 | - | - |
| 保存按钮 | 按钮 | - | 保存标准配置，状态为草稿 | - | - |
| 保存并生效按钮 | 按钮 | - | 保存标准配置并设置为生效状态 | - | - |
| 返回修改按钮 | 按钮 | - | 返回上一步修改配置 | - | - |

### 11.2 费用项管理页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 费用项名称 | 文本输入框 | 长度1-100字符 | 输入费用项名称 | 必填，唯一 | - |
| 费用项分类 | 下拉选择 | 字典项: transport(交通费用), accommodation(住宿费用), meal(餐费), other(其他费用) | 选择费用项所属分类 | 必填 | other |
| 状态 | 下拉选择 | 字典项: active(启用), inactive(停用) | 选择费用项状态 | 必填 | active |
| 父级费用项 | 下拉选择 | 从费用项列表中选择 | 选择父级费用项，用于构建费用项层级结构 | 选填 | 空 |
| 描述 | 多行文本输入框 | 长度0-500字符 | 输入费用项描述 | 选填 | - |
| 搜索框 | 文本输入框 | - | 输入关键词搜索费用项 | - | - |
| 状态筛选 | 下拉选择 | 字典项: all(全部), active(启用), inactive(停用) | 筛选费用项状态 | - | all |
| 分类筛选 | 下拉选择 | 字典项: all(全部), transport, accommodation, meal, other | 筛选费用项分类 | - | all |
| 新增按钮 | 按钮 | - | 打开新增费用项表单 | - | - |
| 编辑按钮 | 按钮 | - | 打开编辑费用项表单 | - | - |
| 删除按钮 | 按钮 | - | 删除费用项，需确认 | 费用项未被使用时才可删除 | - |

### 11.3 标准匹配查询页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 国家 | 下拉选择 | 数据来源：Location API（type='country'），返回countryCode字段 | 选择国家，用于匹配标准 | 选填 | - |
| 城市 | 下拉选择 | 数据来源：Location API（type='city'），根据选择的国家动态加载，返回name或code字段 | 选择城市，用于匹配标准 | 选填 | - |
| 城市级别 | 下拉选择 | 数据来源：字典值（1,2,3,4）或Location API的cityLevel字段 | 选择城市级别，用于匹配标准 | 选填 | - |
| 部门 | 下拉选择 | 数据来源：Department API，返回code字段列表 | 选择部门，用于匹配标准 | 选填 | - |
| 职位 | 下拉选择 | 数据来源：Position API，返回code字段列表 | 选择职位，用于匹配标准 | 选填 | - |
| 职位级别 | 下拉选择 | 数据来源：JobLevel API，返回levelCode字段列表（如P1,P2,P3等） | 选择职位级别，用于匹配标准 | 选填 | - |
| 角色 | 下拉选择 | 数据来源：Role API，返回code字段列表 | 选择角色，用于匹配标准 | 选填 | - |
| 项目代码 | 文本输入框 | 数据来源：用户输入或项目管理系统API | 输入项目代码，用于匹配标准 | 选填 | - |
| 员工类型 | 下拉选择 | 数据来源：字典值（1=社招, 2=校招, 3=实习生, 4=外包） | 选择员工类型，用于匹配标准 | 选填 | - |
| 组织类型 | 下拉选择 | 数据来源：字典值（E0005=正编, E0006=外包, E0007=临时） | 选择组织类型，用于匹配标准 | 选填 | - |
| 管理级别 | 下拉选择 | 数据来源：字典值（manager=部门经理, deputy_manager=部门分管经理, none=无） | 选择管理级别，用于匹配标准 | 选填 | - |
| 职位类别 | 下拉选择 | 数据来源：字典值（11=职能, 12=技术, 13=销售, 14=管理） | 选择职位类别，用于匹配标准 | 选填 | - |
| 差旅天数 | 数字输入框 | 大于0的整数 | 输入差旅天数，用于匹配约束条件 | 选填 | - |
| 差旅类型 | 下拉选择 | 字典项: domestic(国内), international(国际) | 选择差旅类型，用于匹配约束条件 | 选填 | - |
| 差旅目的 | 下拉选择 | 字典项: meeting(会议), training(培训), project(项目), customer_visit(客户拜访) | 选择差旅目的，用于匹配约束条件 | 选填 | - |
| 匹配策略 | 下拉选择 | 字典项: PRIORITY(优先级策略), MERGE_BEST(合并最优), MERGE_ALL(合并所有) | 选择匹配策略，用于处理多个匹配规则 | 选填 | MERGE_BEST |
| 查询按钮 | 按钮 | - | 执行标准匹配查询 | - | - |
| 匹配结果展示 | 只读展示 | 显示匹配的标准和费用项列表 | 展示匹配的标准信息、可用费用项、不可用费用项及原因 | - | - |

### 11.4 标准列表管理页面

| 页面核心元素 | 类型 | 数据范围 | 操作逻辑 | 限制条件 | 默认值 |
|------------|------|---------|---------|---------|--------|
| 标准代码搜索 | 文本输入框 | - | 输入标准代码关键词搜索 | - | - |
| 标准名称搜索 | 文本输入框 | - | 输入标准名称关键词搜索 | - | - |
| 状态筛选 | 下拉选择 | 字典项: all(全部), draft(草稿), active(生效), expired(已过期) | 筛选标准状态 | - | all |
| 优先级范围 | 数字范围选择 | 0-100的整数 | 选择优先级范围，筛选该范围内的标准 | - | - |
| 生效日期范围 | 日期范围选择 | 日期格式（YYYY-MM-DD） | 选择生效日期范围，筛选该范围内的标准 | - | - |
| 查询按钮 | 按钮 | - | 执行查询操作 | - | - |
| 重置按钮 | 按钮 | - | 重置所有筛选条件 | - | - |
| 新增按钮 | 按钮 | - | 打开新增标准表单 | - | - |
| 编辑按钮 | 按钮 | - | 打开编辑标准表单 | - | - |
| 删除按钮 | 按钮 | - | 删除标准，需确认 | - | - |
| 标准列表表格 | 表格展示 | 显示标准代码、名称、状态、优先级、生效日期、失效日期、创建时间 | 展示标准列表，支持排序、分页 | - | - |
| 分页控件 | 分页组件 | 每页显示数量: 10, 20, 50, 100 | 控制列表分页显示 | - | 每页10条 |

---

## 十二、附录

### 12.1 相关模型

- `TravelStandard`: 差旅标准模型
- `ExpenseItem`: 费用项模型
- `Location`: 地理位置模型
- `CityLevel`: 城市级别模型
- `Department`: 部门模型
- `Position`: 职位模型
- `Role`: 角色模型

### 12.2 相关API

- `/api/travel-standards`: 标准管理API
- `/api/travel-standards/match`: 标准匹配API
- `/api/expense-items`: 费用项管理API
- `/api/locations`: 地理位置管理API

### 12.3 相关文档

- 差旅申请流程文档
- 审批流程配置文档
- 费用报销规则文档

---

**文档结束**

