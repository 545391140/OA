# 审批统计显示说明

## 问题：为什么前端显示 2条待审，2条已通过？

### 数据库实际情况

根据数据库检查结果，当前有3条差旅申请，共4条审批记录：

#### 差旅申请 #1 (TR-20251109-0001)
- 整体状态: `approved` (已批准)
- 审批记录: 1条
  - 审批人: 690617cb96b82211119d479f
  - 级别: 1
  - 状态: **approved** ✅
  - 审批时间: 2025-11-09 06:40:12

#### 差旅申请 #2 (TR-20251109-0002)
- 整体状态: `approved` (已批准)
- 审批记录: 1条
  - 审批人: 690617cb96b82211119d479f
  - 级别: 1
  - 状态: **approved** ✅
  - 审批时间: 2025-11-09 06:42:21

#### 差旅申请 #3 (TR-20251109-0003)
- 整体状态: `submitted` (已提交，待审批)
- 审批记录: 2条
  - 审批 #1:
    - 审批人: 690617cb96b82211119d479f
    - 级别: 1
    - 状态: **pending** ⏳
    - 审批时间: 未审批
  - 审批 #2:
    - 审批人: 690617cb96b82211119d479f
    - 级别: 2
    - 状态: **pending** ⏳
    - 审批时间: 未审批

### 统计汇总

**审批记录级别的统计**（这是统计API返回的数据）：
- ✅ 已批准: **2条** (申请#1的1条 + 申请#2的1条)
- ⏳ 待审批: **2条** (申请#3的2条)
- ❌ 已拒绝: **0条**
- 📊 总计: **4条审批记录**

### 为什么是这样？

#### 1. 统计API的逻辑

统计API (`/api/approvals/statistics`) 统计的是**审批记录**的数量，而不是**申请**的数量。

```javascript
// 后端代码逻辑
pipeline.push(
  { $unwind: '$approvals' },  // 展开审批数组，每条审批记录变成一条文档
  {
    $group: {
      _id: '$approvals.status',  // 按审批状态分组
      count: { $sum: 1 }         // 统计每个状态的记录数
    }
  }
);
```

这意味着：
- 如果一个申请有2条审批记录（如申请#3），它会被统计为2条
- 每条审批记录根据其状态（pending/approved/rejected）单独统计

#### 2. 审批流程说明

申请#3 有2条审批记录是因为它配置了**两级审批**：
- **一级审批**：级别1，审批人相同，状态pending
- **二级审批**：级别2，审批人相同，状态pending

这是一个多级审批流程，需要依次通过两级审批才能最终批准。

#### 3. 审批列表 vs 审批统计

**审批列表页面** (`/approvals`)：
- 显示的是**待审批的申请**数量
- 查询条件: `'approvals.status': 'pending'`
- 结果: 1条申请（申请#3）

**审批统计页面** (`/approvals/statistics`)：
- 显示的是**审批记录**的统计
- 统计所有审批记录的状态分布
- 结果: 2条pending记录 + 2条approved记录 = 4条记录

### 这是正常的吗？

✅ **是的，这是完全正常的！**

这反映了系统的真实审批情况：
1. 有2个申请已经完成审批（各有1条approved记录）
2. 有1个申请正在审批中（有2条pending记录，因为是两级审批）

### 如何理解统计数据

#### 从审批记录角度（当前实现）
- **优点**：
  - 反映真实的审批工作量
  - 多级审批会被正确统计
  - 适合分析审批人的工作量
  
- **数据含义**：
  - "2条待审" = 有2条审批记录等待处理
  - "2条已通过" = 有2条审批记录已批准

#### 从申请角度（另一种视角）
如果要统计申请数量而不是审批记录数量，需要修改统计逻辑：
- "1个申请待审" = 有1个申请处于submitted状态
- "2个申请已通过" = 有2个申请处于approved状态

### 建议

当前的统计方式（按审批记录统计）是合理的，因为：

1. **反映真实工作量**：如果一个申请需要3级审批，它确实产生了3条审批工作
2. **适合多级审批**：系统支持多级审批流程，按记录统计更准确
3. **审批人视角**：从审批人角度看，每条pending记录都是一项待处理的工作

如果需要同时显示两种统计方式，可以：
1. 保持当前的"审批记录统计"
2. 添加一个"申请统计"维度，显示有多少个申请处于各种状态

### 验证

可以通过以下脚本验证数据：
```bash
cd backend
node scripts/checkAllApprovals.js
```

这会显示所有审批记录的详细信息，包括每个申请的审批流程。

