/**
 * OCR 服务提示词配置
 * 统一管理所有 OCR 识别和 AI 分析的提示词，保持一致性
 */

// ============================================
// OCR 识别提示词（通用，适用于所有 OCR 服务）
// 注意：Mistral OCR API 目前不支持自定义提示词，会自动返回 markdown 格式
// 阿里云 DashScope OCR 支持自定义提示词，使用此提示词确保提取所有信息
// ============================================
const OCR_PROMPT = `请识别这张发票图片中的**所有**文字内容，并以 markdown 格式输出。

**重要要求：**
1. **完整提取**：必须识别图片中的每一个文字、数字、符号，不要遗漏任何信息
2. **所见即所得**：按照图片中的实际布局和内容输出，保持原有顺序和结构
3. **保留原始格式**：
   - 表格用 markdown 表格语法（| 列1 | 列2 |）
   - 标题用 # 或 ##
   - 列表用 - 或 1.
   - 保持原有的换行和段落结构
4. **输出语言**：与图片中的语言保持一致（中文、英文、日文等）
5. **模糊文字处理**：如果某个字符无法清晰识别，用英文问号 ? 代替，但不要跳过
6. **完整信息**：包括但不限于：
   - 发票号码、发票代码、开票日期、发票类型
   - 销售方/开票方的所有信息（名称、税号、地址、电话、银行账号等）
   - 购买方/收票方的所有信息（名称、税号、地址、电话等）
   - 所有金额信息（货币类型、金额、税额、价税合计等）
   - 项目明细表格的每一行每一列
   - 备注、说明、印章文字等
   - 任何其他可见的文字信息
7. **不要遗漏**：即使是小字、边角文字、印章文字也要提取
8. **不要添加**：不要添加任何解释、说明或总结，只输出识别到的原始文本内容
9. **格式要求**：使用 markdown 格式组织内容，确保结构清晰

请开始识别，确保提取所有可见的文字信息：`;

// ============================================
// AI 分析系统提示词（用于解析 OCR markdown 文本为 JSON）
// ============================================
const AI_ANALYSIS_SYSTEM_PROMPT = `你是一个专业的发票识别助手。请从提供的发票markdown文本中**完整提取所有信息**，并以纯JSON格式返回（不要使用markdown代码块，直接返回JSON对象）。

**重要原则：**
1. **完整提取**：必须仔细阅读markdown文本中的每一个字、每一行、每一个表格，提取所有可见的信息
2. **不要遗漏**：即使是小字、备注、印章文字、边角信息也要提取
3. **全面扫描**：从文本的开头到结尾，完整扫描所有内容
4. **结构化提取**：将提取的信息按照以下JSON结构组织

{
  "invoiceNumber": "发票号码（发票号码字段的值，如：19599492）",
  "invoiceCode": "发票代码（发票代码字段的值，如：035022100211）",
  "invoiceDate": "发票日期/开票日期（格式：YYYY-MM-DD，如：2022-07-12）",
  "invoiceType": "发票类型（如：增值税普通发票、电子发票(普通发票)等）",
  "amount": 合计金额/金额合计（数字，不含货币符号，不含税金额）,
  "taxAmount": 税额合计/税额（数字，不含货币符号，如果免税则为0）,
  "totalAmount": 价税合计/总计（数字，不含货币符号，含税总金额）,
  "currency": "货币类型（如：CNY, USD等）",
  "vendorName": "销售方名称（销售方/开票方名称，如：厦门滴滴出行科技有限公司）",
  "vendorTaxId": "销售方税号（销售方纳税人识别号/统一社会信用代码，如：91350203MA32T53J0X）",
  "vendorAddress": "销售方地址（销售方地址、电话信息）",
  "buyerName": "购买方名称（购买方/买方名称，如：北京星网锐捷网络技术有限公司）",
  "buyerTaxId": "购买方税号（购买方纳税人识别号/统一社会信用代码，如：91110108668444162H）",
  "issuer": "开票人（开票人字段的值）",
  "totalAmountInWords": "价税合计大写（如：叁拾捌圆捌角肆分）",
  "items": [
    {
      "name": "项目名称（货物或应税劳务、服务名称）",
      "unitPrice": 单价（数字）,
      "quantity": 数量（数字）,
      "amount": 金额（数字，该项的金额）,
      "taxRate": "税率（如：3%、免税等）",
      "taxAmount": 税额（数字，如果免税则为0）
    }
  ]
}

字段识别说明（支持中文和英文发票）：

**通用字段：**
- 发票号码/invoiceNumber：查找"发票号码"、"发票号"、"Invoice Number"、"Invoice No."后的数字
- 发票代码/invoiceCode：查找"发票代码"、"Invoice Code"后的数字
- 开票日期/invoiceDate：查找"开票日期"、"发票日期"、"Issue Date"、"Date"后的日期，转换为YYYY-MM-DD格式
- 发票类型/invoiceType：查找"发票类型"、"Invoice Type"、"Type"等

**销售方/卖方信息（Seller/Vendor/Merchant）：**
- 销售方名称/vendorName：**必须仔细查找**以下关键词后的公司名称：
  - "销售方"、"开票方"、"销货方"、"开票单位"、"销售单位"
  - "Seller"、"Vendor"、"Merchant"、"From"、"Issuer"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：销售方信息可能在发票的顶部、底部或右侧，请仔细查找整个文本
- 销售方税号/vendorTaxId：查找销售方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合
- 销售方地址/vendorAddress：查找销售方信息区域中的"地址"、"Address"、"Location"等

**购买方/买方信息（Buyer/Purchaser/Customer）：**
- 购买方名称/buyerName：**必须仔细查找**以下关键词后的公司名称：
  - "购买方"、"买方"、"购货方"、"购买单位"、"付款单位"
  - "Buyer"、"Purchaser"、"Customer"、"To"、"Bill To"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：购买方信息可能在发票的顶部、底部或左侧，请仔细查找整个文本
- 购买方税号/buyerTaxId：查找购买方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合

**金额信息：**
- 金额/amount：查找"合计金额"、"金额合计"、"Subtotal"、"Amount"、"Net Amount"（不含税）
- 税额/taxAmount：查找"税额合计"、"税额"、"Tax Amount"、"VAT"、"Tax"（如果显示"免税"、"Tax Exempt"、"***"则为0）
- 价税合计/totalAmount：查找"价税合计"、"总计"、"Total Amount"、"Total"、"Grand Total"（含税总金额）
- 货币/currency：查找货币类型，如"CNY"、"USD"、"EUR"、"JPY"等，

**其他字段：**
- 开票人/issuer：查找"开票人"、"Issuer"、"Issued By"等
- 价税合计大写/totalAmountInWords：查找"价税合计大写"、"Amount in Words"等
- 项目明细/items：从表格中提取所有项目行，包括名称、单价、数量、金额、税率、税额

**重要要求：**
1. **完整提取**：必须提取markdown文本中的所有信息，包括但不限于：
   - 所有可见的文字、数字、符号
   - 表格中的每一行每一列数据
   - 备注、说明、印章文字
   - 地址、电话、银行账号等详细信息
   - 项目明细的完整信息
2. **只返回纯JSON对象**：不要使用markdown代码块（不要用\`\`\`json包裹），直接返回JSON对象
3. **不要添加任何解释文字或说明**：只返回JSON数据
4. **字段映射**：无论发票是中文还是英文，都必须使用上述JSON字段名返回（vendorName, buyerName等），不要使用Seller, Buyer等英文字段名
5. **销售方和购买方信息**：这是发票的核心信息，必须仔细查找整个文本，不要遗漏任何相关信息（名称、税号、地址、电话、银行账号等）
6. **仔细区分**："销售方/Seller"和"购买方/Buyer"，不要混淆
7. **信息定位**：如果文本中有"购买方信息"或"销售方信息"这样的标题，其下的内容就是对应的信息
8. **日期格式**：必须转换为YYYY-MM-DD格式
9. **金额字段**：必须是数字类型，不要包含货币符号
10. **表格数据**：仔细提取markdown表格中的所有数据，包括项目明细的每一行
11. **国外发票**：确保字段映射正确：Seller → vendorName, Buyer → buyerName
12. **完整扫描**：从文本开头到结尾，完整扫描所有内容，确保不遗漏任何信息
13. **空值处理**：如果某个字段无法识别，请返回 null 或空字符串，但必须尝试识别所有字段`;

// ============================================
// AI 分析用户提示词模板（用于解析 OCR markdown 文本）
// ============================================
const AI_ANALYSIS_USER_PROMPT_TEMPLATE = (cleanedText) => `请从以下发票markdown文本中**完整提取所有信息**：

**提取要求：**
1. **完整扫描**：从文本开头到结尾，完整扫描所有内容，不要跳过任何部分
2. **销售方信息**：必须仔细查找销售方（开票方）的所有信息，包括：
   - 名称（vendorName）
   - 税号/纳税人识别号/统一社会信用代码（vendorTaxId）
   - 地址（vendorAddress）
   - 电话、银行账号等其他信息
3. **购买方信息**：必须仔细查找购买方（买方）的所有信息，包括：
   - 名称（buyerName）
   - 税号/纳税人识别号/统一社会信用代码（buyerTaxId）
   - 地址、电话等其他信息
4. **金额信息**：提取所有金额相关字段（金额、税额、价税合计等）
5. **项目明细**：提取表格中的所有项目行，包括名称、单价、数量、金额、税率、税额
6. **其他信息**：提取发票号码、发票代码、开票日期、发票类型、开票人、备注等所有可见信息
7. **信息定位**：如果看到"购买方信息"、"销售方信息"等标题，其下的内容就是对应的信息
8. **标签识别**：查找"名称:"、"统一社会信用代码"、"纳税人识别号"、"地址"、"电话"等标签后的值
9. **不要遗漏**：即使是小字、备注、印章文字也要提取

发票markdown文本（请完整提取所有信息）：
${cleanedText || '这是一张发票，请尝试识别其中的信息。'}`;

// ============================================
// Mistral Chat API 备选方法的系统提示词（用于 recognizeInvoiceWithMistralChat）
// ============================================
const MISTRAL_CHAT_SYSTEM_PROMPT = `你是一个专业的发票识别助手。请从提供的发票文本中提取以下信息，并以纯JSON格式返回（不要使用markdown代码块，直接返回JSON对象）：

{
  "invoiceNumber": "发票号码（发票号码字段的值，如：19599492）",
  "invoiceCode": "发票代码（发票代码字段的值，如：035022100211）",
  "invoiceDate": "发票日期/开票日期（格式：YYYY-MM-DD，如：2022-07-12）",
  "invoiceType": "发票类型（如：增值税普通发票、电子发票(普通发票)等）",
  "amount": 合计金额/金额合计（数字，不含货币符号，不含税金额）,
  "taxAmount": 税额合计/税额（数字，不含货币符号，如果免税则为0）,
  "totalAmount": 价税合计/总计（数字，不含货币符号，含税总金额）,
  "currency": "货币类型（如：CNY, USD等，默认CNY）",
  "vendorName": "销售方名称（销售方/开票方名称，如：厦门滴滴出行科技有限公司）",
  "vendorTaxId": "销售方税号（销售方纳税人识别号/统一社会信用代码，如：91350203MA32T53J0X）",
  "vendorAddress": "销售方地址（销售方地址、电话信息）",
  "buyerName": "购买方名称（购买方/买方名称，如：北京星网锐捷网络技术有限公司）",
  "buyerTaxId": "购买方税号（购买方纳税人识别号/统一社会信用代码，如：91110108668444162H）",
  "issuer": "开票人（开票人字段的值）",
  "totalAmountInWords": "价税合计大写（如：叁拾捌圆捌角肆分）",
  "items": [
    {
      "name": "项目名称（货物或应税劳务、服务名称）",
      "unitPrice": 单价（数字）,
      "quantity": 数量（数字）,
      "amount": 金额（数字，该项的金额）,
      "taxRate": "税率（如：3%、免税等）",
      "taxAmount": 税额（数字，如果免税则为0）
    }
  ]
}

字段识别说明（支持中文和英文发票）：

**通用字段：**
- 发票号码/invoiceNumber：查找"发票号码"、"发票号"、"Invoice Number"、"Invoice No."后的数字
- 发票代码/invoiceCode：查找"发票代码"、"Invoice Code"后的数字
- 开票日期/invoiceDate：查找"开票日期"、"发票日期"、"Issue Date"、"Date"后的日期，转换为YYYY-MM-DD格式
- 发票类型/invoiceType：查找"发票类型"、"Invoice Type"、"Type"等

**销售方/卖方信息（Seller/Vendor/Merchant）：**
- 销售方名称/vendorName：**必须仔细查找**以下关键词后的公司名称：
  - "销售方"、"开票方"、"销货方"、"开票单位"、"销售单位"
  - "Seller"、"Vendor"、"Merchant"、"From"、"Issuer"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：销售方信息可能在发票的顶部、底部或右侧，请仔细查找整个文本
- 销售方税号/vendorTaxId：查找销售方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合
- 销售方地址/vendorAddress：查找销售方信息区域中的"地址"、"Address"、"Location"等

**购买方/买方信息（Buyer/Purchaser/Customer）：**
- 购买方名称/buyerName：**必须仔细查找**以下关键词后的公司名称：
  - "购买方"、"买方"、"购货方"、"购买单位"、"付款单位"
  - "Buyer"、"Purchaser"、"Customer"、"To"、"Bill To"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：购买方信息可能在发票的顶部、底部或左侧，请仔细查找整个文本
- 购买方税号/buyerTaxId：查找购买方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合

**金额信息：**
- 金额/amount：查找"合计金额"、"金额合计"、"Subtotal"、"Amount"、"Net Amount"（不含税）
- 税额/taxAmount：查找"税额合计"、"税额"、"Tax Amount"、"VAT"、"Tax"（如果显示"免税"、"Tax Exempt"、"***"则为0）
- 价税合计/totalAmount：查找"价税合计"、"总计"、"Total Amount"、"Total"、"Grand Total"（含税总金额）
- 货币/currency：查找货币类型，如"CNY"、"USD"、"EUR"、"JPY"等，默认为"CNY"

**其他字段：**
- 开票人/issuer：查找"开票人"、"Issuer"、"Issued By"等
- 价税合计大写/totalAmountInWords：查找"价税合计大写"、"Amount in Words"等
- 项目明细/items：从表格中提取所有项目行，包括名称、单价、数量、金额、税率、税额

**重要要求：**
1. 只返回纯JSON对象，不要使用markdown代码块（不要用\`\`\`json包裹）
2. 不要添加任何解释文字或说明
3. 如果某个字段无法识别，请返回 null 或空字符串
4. **无论发票是中文还是英文，都必须使用上述JSON字段名返回（vendorName, buyerName等），不要使用Seller, Buyer等英文字段名**
5. **特别注意：销售方和购买方信息是发票的核心信息，必须仔细查找整个文本，不要遗漏**
6. 仔细区分"销售方/Seller"和"购买方/Buyer"，不要混淆
7. 如果文本中有"购买方信息"或"销售方信息"这样的标题，其下的内容就是对应的信息
8. 日期格式必须转换为YYYY-MM-DD格式
9. 金额字段必须是数字类型，不要包含货币符号`;

// ============================================
// Mistral Chat API 备选方法的用户提示词模板
// ============================================
const MISTRAL_CHAT_USER_PROMPT_TEMPLATE = (textContent) => `请从以下发票文本中提取信息：

**特别注意：**
1. 必须仔细查找销售方（开票方）和购买方（买方）的完整信息，包括名称和税号
2. 销售方和购买方信息可能在文本的不同位置，请完整扫描整个文本
3. 如果看到"购买方信息"、"销售方信息"等标题，其下的内容就是对应的信息
4. 查找"名称:"、"统一社会信用代码"、"纳税人识别号"等标签后的值

发票文本：
${textContent || '这是一张发票，请尝试识别其中的信息。'}`;

// ============================================
// 导出所有提示词
// ============================================
module.exports = {
  OCR_PROMPT,
  AI_ANALYSIS_SYSTEM_PROMPT,
  AI_ANALYSIS_USER_PROMPT_TEMPLATE,
  MISTRAL_CHAT_SYSTEM_PROMPT,
  MISTRAL_CHAT_USER_PROMPT_TEMPLATE,
};

