/**
 * OCR 服务提示词配置
 * 统一管理所有 OCR 识别和 AI 分析的提示词，保持一致性
 */

// ============================================
// OCR 识别提示词（通用，适用于所有 OCR 服务）
// 注意：Mistral OCR API 目前不支持自定义提示词，会自动返回 markdown 格式
// 阿里云 DashScope OCR 支持自定义提示词，使用此提示词确保提取所有信息
// ============================================
const OCR_PROMPT = `请识别这张发票图片中的所有文字内容，并以 markdown 格式输出。`;

// ============================================
// AI 分析系统提示词（用于解析 OCR markdown 文本为 JSON）
// ============================================
const AI_ANALYSIS_SYSTEM_PROMPT = `你是一个专业的发票识别助手。请从提供的发票markdown文本中**完整提取所有信息**，并以纯JSON格式返回（不要使用markdown代码块，直接返回JSON对象）。

**重要原则：**
1. **完整提取**：必须仔细阅读markdown文本中的每一个字、每一行、每一个表格，提取所有可见的信息
2. **不要遗漏**：即使是小字、备注、印章文字、边角信息也要提取
3. **全面扫描**：从文本的开头到结尾，完整扫描所有内容
4. **结构化提取**：将提取的信息按照以下JSON结构组织
5. **字段完整性**：必须返回所有字段，即使字段值为空也要返回 null，不能省略任何字段

**必须返回的JSON结构（所有字段都必须存在，不能省略）：**

{
  "invoiceNumber": "发票号码（字符串，如：19599492，如果未识别则返回 null）",
  "invoiceCode": "发票代码（字符串，如：035022100211，如果未识别则返回 null）",
  "invoiceDate": "发票日期/开票日期（字符串，格式：YYYY-MM-DD，如：2022-07-12，如果未识别则返回 null）",
  "invoiceType": "发票类型（字符串，如：增值税普通发票、电子发票(普通发票)等，如果未识别则返回 null）",
  "amount": 合计金额/金额合计（数字，不含货币符号，不含税金额，如果未识别则返回 null）,
  "taxAmount": 税额合计/税额（数字，不含货币符号，如果免税则为0，如果未识别则返回 null）,
  "totalAmount": 价税合计/总计（数字，不含货币符号，含税总金额，如果未识别则返回 null）,
  "currency": "货币类型（字符串，如：CNY, USD等，如果未识别则返回 null）",
  "vendorName": "销售方名称（字符串，销售方/开票方名称，如：厦门滴滴出行科技有限公司，如果未识别则返回 null）",
  "vendorTaxId": "销售方税号（字符串，销售方纳税人识别号/统一社会信用代码，如：91350203MA32T53J0X，如果未识别则返回 null）",
  "vendorAddress": "销售方地址（字符串，销售方地址、电话信息，如果未识别则返回 null）",
  "buyerName": "购买方名称（字符串，购买方/买方名称，如：北京星网锐捷网络技术有限公司，如果未识别则返回 null）",
  "buyerTaxId": "购买方税号（字符串，购买方纳税人识别号/统一社会信用代码，如：91110108668444162H，如果未识别则返回 null）",
  "buyerAddress": "购买方地址（字符串，购买方地址、电话信息，如果未识别则返回 null）",
  "issuer": "开票人（字符串，开票人字段的值，如果未识别则返回 null）",
  "totalAmountInWords": "价税合计大写（字符串，如：叁拾捌圆捌角肆分，如果未识别则返回 null）",
  "category": "发票分类（字符串，AI分析得到的分类，必须是以下之一：交通、住宿、餐饮、娱乐、通讯、办公用品、培训、其他，如果无法确定分类则返回\"其他\"）",
  "items": [
    {
      "name": "项目名称（字符串，货物或应税劳务、服务名称，如果未识别则返回 null）",
      "unitPrice": 单价（数字，如果未识别则返回 null）,
      "quantity": 数量（数字，如果未识别则返回 null）,
      "amount": 金额（数字，该项的金额，如果未识别则返回 null）,
      "taxRate": "税率（字符串，如：3%、免税等，如果未识别则返回 null）",
      "taxAmount": 税额（数字，如果免税则为0，如果未识别则返回 null）
    }
  ]
}

**字段返回规则：**
1. **所有字段必须存在**：即使字段值为空，也必须返回该字段，值为 null
2. **字符串字段**：如果未识别到值，返回 null（不是空字符串 ""）
3. **数字字段**：如果未识别到值，返回 null（不是 0）
4. **数组字段 items**：如果未识别到项目明细，返回空数组 []（不是 null）
5. **items 数组中的对象**：每个 item 对象的所有字段都必须存在，未识别的字段返回 null

字段识别说明（支持中文和英文发票）：

**通用字段：**
- 发票号码/invoiceNumber：查找"发票号码"、"发票号"、"Invoice Number"、"Invoice No."后的数字
- 发票代码/invoiceCode：查找"发票代码"、"Invoice Code"后的数字
- 开票日期/invoiceDate：查找"开票日期"、"发票日期"、"Issue Date"、"Date"后的日期，转换为YYYY-MM-DD格式
- 发票类型/invoiceType：查找"发票类型"、"Invoice Type"、"Type"等
- 发票分类 这个字段是你通过分析得到的。大概包含这些：交通、住宿、餐饮、娱乐、通讯、办公用品、培训、其他

**销售方/卖方信息（Seller/Vendor/Merchant）：**
- 销售方名称/vendorName：**必须仔细查找**以下关键词后的公司名称：
  - "销售方"、"开票方"、"销货方"、"开票单位"、"销售单位"
  - "Seller"、"Vendor"、"Merchant"、"From"、"Issuer"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：销售方信息可能在发票的顶部、底部或右侧，请仔细查找整个文本
- 销售方税号/vendorTaxId：查找销售方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合
- 销售方地址/vendorAddress：查找销售方信息区域中的"地址"、"Address"、"Location"等

**购买方/买方信息（Buyer/Purchaser/Customer）：**
- 购买方名称/buyerName：**必须仔细查找**以下关键词后的公司名称：
  - "购买方"、"买方"、"购货方"、"购买单位"、"付款单位"
  - "Buyer"、"Purchaser"、"Customer"、"To"、"Bill To"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：购买方信息可能在发票的顶部、底部或左侧，请仔细查找整个文本
- 购买方税号/buyerTaxId：查找购买方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合

**金额信息：**
- 金额/amount：查找"合计金额"、"金额合计"、"Subtotal"、"Amount"、"Net Amount"（不含税）
- 税额/taxAmount：查找"税额合计"、"税额"、"Tax Amount"、"VAT"、"Tax"（如果显示"免税"、"Tax Exempt"、"***"则为0）
- 价税合计/totalAmount：查找"价税合计"、"总计"、"Total Amount"、"Total"、"Grand Total"（含税总金额）
- 货币/currency：查找货币类型，如"CNY"、"USD"、"EUR"、"JPY"等，

**其他字段：**
- 开票人/issuer：查找"开票人"、"Issuer"、"Issued By"等
- 价税合计大写/totalAmountInWords：查找"价税合计大写"、"Amount in Words"等
- 发票分类/category：**AI分析字段**，根据发票内容（项目名称、销售方、金额等）智能判断分类，必须是以下之一：
  - "交通"：出租车、网约车、机票、火车票、船票、停车费等交通相关费用
  - "住宿"：酒店、宾馆、民宿等住宿相关费用
  - "餐饮"：餐厅、外卖、食品、饮料等餐饮相关费用
  - "娱乐"：电影、KTV、游戏、旅游景点门票等娱乐相关费用
  - "通讯"：电话费、网络费、手机费、宽带费等通讯相关费用
  - "办公用品"：文具、办公设备、打印、复印等办公用品相关费用
  - "培训"：培训费、教育费、课程费等培训相关费用
  - "其他"：不属于以上分类的其他费用，或无法确定分类时返回此值
- 项目明细/items：从表格中提取所有项目行，包括名称、单价、数量、金额、税率、税额

**重要要求：**
1. **完整提取**：必须提取markdown文本中的所有信息，包括但不限于：
   - 所有可见的文字、数字、符号
   - 表格中的每一行每一列数据
   - 备注、说明、印章文字
   - 地址、电话、银行账号等详细信息
   - 项目明细的完整信息
2. **只返回纯JSON对象**：不要使用markdown代码块（不要用\`\`\`json包裹），直接返回JSON对象
3. **不要添加任何解释文字或说明**：只返回JSON数据
4. **字段完整性**：必须返回上述JSON结构中的所有字段，不能省略任何字段
5. **空值处理**：如果某个字段无法识别，必须返回 null（字符串字段和数字字段都返回 null，不是空字符串或0）
6. **字段映射**：无论发票是中文还是英文，都必须使用上述JSON字段名返回（vendorName, buyerName等），不要使用Seller, Buyer等英文字段名
7. **销售方和购买方信息**：这是发票的核心信息，必须仔细查找整个文本，不要遗漏任何相关信息（名称、税号、地址、电话、银行账号等）
8. **仔细区分**："销售方/Seller"和"购买方/Buyer"，不要混淆
9. **信息定位**：如果文本中有"购买方信息"或"销售方信息"这样的标题，其下的内容就是对应的信息
10. **日期格式**：必须转换为YYYY-MM-DD格式，如果未识别则返回 null
11. **金额字段**：必须是数字类型，不要包含货币符号，如果未识别则返回 null
12. **表格数据**：仔细提取markdown表格中的所有数据，包括项目明细的每一行
13. **国外发票**：确保字段映射正确：Seller → vendorName, Buyer → buyerName
14. **完整扫描**：从文本开头到结尾，完整扫描所有内容，确保不遗漏任何信息
15. **items 数组**：如果未识别到项目明细，返回空数组 []，数组中的每个对象必须包含所有字段（name, unitPrice, quantity, amount, taxRate, taxAmount），未识别的字段返回 null`;

// ============================================
// AI 分析用户提示词模板（用于解析 OCR markdown 文本）
// ============================================
const AI_ANALYSIS_USER_PROMPT_TEMPLATE = (cleanedText) => `请从以下发票markdown文本中**完整提取所有信息**：

**提取要求：**
1. **完整扫描**：从文本开头到结尾，完整扫描所有内容，不要跳过任何部分
2. **销售方信息**：必须仔细查找销售方（开票方）的所有信息，包括：
   - 名称（vendorName）
   - 税号/纳税人识别号/统一社会信用代码（vendorTaxId）
   - 地址（vendorAddress）
   - 电话、银行账号等其他信息
3. **购买方信息**：必须仔细查找购买方（买方）的所有信息，包括：
   - 名称（buyerName）
   - 税号/纳税人识别号/统一社会信用代码（buyerTaxId）
   - 地址、电话等其他信息
4. **金额信息**：提取所有金额相关字段（金额、税额、价税合计等）
5. **项目明细**：提取表格中的所有项目行，包括名称、单价、数量、金额、税率、税额
6. **其他信息**：提取发票号码、发票代码、开票日期、发票类型、开票人、备注等所有可见信息
7. **信息定位**：如果看到"购买方信息"、"销售方信息"等标题，其下的内容就是对应的信息
8. **标签识别**：查找"名称:"、"统一社会信用代码"、"纳税人识别号"、"地址"、"电话"等标签后的值
9. **不要遗漏**：即使是小字、备注、印章文字也要提取

发票markdown文本（请完整提取所有信息）：
${cleanedText || '这是一张发票，请尝试识别其中的信息。'}`;

// ============================================
// Mistral Chat API 备选方法的系统提示词（用于 recognizeInvoiceWithMistralChat）
// ============================================
const MISTRAL_CHAT_SYSTEM_PROMPT = `你是一个专业的发票识别助手。请从提供的发票文本中提取以下信息，并以纯JSON格式返回（不要使用markdown代码块，直接返回JSON对象）。

**必须返回的JSON结构（所有字段都必须存在，不能省略）：**

{
  "invoiceNumber": "发票号码（字符串，如：19599492，如果未识别则返回 null）",
  "invoiceCode": "发票代码（字符串，如：035022100211，如果未识别则返回 null）",
  "invoiceDate": "发票日期/开票日期（字符串，格式：YYYY-MM-DD，如：2022-07-12，如果未识别则返回 null）",
  "invoiceType": "发票类型（字符串，如：增值税普通发票、电子发票(普通发票)等，如果未识别则返回 null）",
  "amount": 合计金额/金额合计（数字，不含货币符号，不含税金额，如果未识别则返回 null）,
  "taxAmount": 税额合计/税额（数字，不含货币符号，如果免税则为0，如果未识别则返回 null）,
  "totalAmount": 价税合计/总计（数字，不含货币符号，含税总金额，如果未识别则返回 null）,
  "currency": "货币类型（字符串，如：CNY, USD等，默认CNY，如果未识别则返回 null）",
  "vendorName": "销售方名称（字符串，销售方/开票方名称，如：厦门滴滴出行科技有限公司，如果未识别则返回 null）",
  "vendorTaxId": "销售方税号（字符串，销售方纳税人识别号/统一社会信用代码，如：91350203MA32T53J0X，如果未识别则返回 null）",
  "vendorAddress": "销售方地址（字符串，销售方地址、电话信息，如果未识别则返回 null）",
  "buyerName": "购买方名称（字符串，购买方/买方名称，如：北京星网锐捷网络技术有限公司，如果未识别则返回 null）",
  "buyerTaxId": "购买方税号（字符串，购买方纳税人识别号/统一社会信用代码，如：91110108668444162H，如果未识别则返回 null）",
  "buyerAddress": "购买方地址（字符串，购买方地址、电话信息，如果未识别则返回 null）",
  "issuer": "开票人（字符串，开票人字段的值，如果未识别则返回 null）",
  "totalAmountInWords": "价税合计大写（字符串，如：叁拾捌圆捌角肆分，如果未识别则返回 null）",
  "category": "发票分类（字符串，AI分析得到的分类，必须是以下之一：交通、住宿、餐饮、娱乐、通讯、办公用品、培训、其他，如果无法确定分类则返回\"其他\"）",
  "items": [
    {
      "name": "项目名称（字符串，货物或应税劳务、服务名称，如果未识别则返回 null）",
      "unitPrice": 单价（数字，如果未识别则返回 null）,
      "quantity": 数量（数字，如果未识别则返回 null）,
      "amount": 金额（数字，该项的金额，如果未识别则返回 null）,
      "taxRate": "税率（字符串，如：3%、免税等，如果未识别则返回 null）",
      "taxAmount": 税额（数字，如果免税则为0，如果未识别则返回 null）
    }
  ]
}

**字段返回规则：**
1. **所有字段必须存在**：即使字段值为空，也必须返回该字段，值为 null
2. **字符串字段**：如果未识别到值，返回 null（不是空字符串 ""）
3. **数字字段**：如果未识别到值，返回 null（不是 0，除非明确是免税税额）
4. **数组字段 items**：如果未识别到项目明细，返回空数组 []（不是 null）
5. **items 数组中的对象**：每个 item 对象的所有字段都必须存在，未识别的字段返回 null

字段识别说明（支持中文和英文发票）：

**通用字段：**
- 发票号码/invoiceNumber：查找"发票号码"、"发票号"、"Invoice Number"、"Invoice No."后的数字
- 发票代码/invoiceCode：查找"发票代码"、"Invoice Code"后的数字
- 开票日期/invoiceDate：查找"开票日期"、"发票日期"、"Issue Date"、"Date"后的日期，转换为YYYY-MM-DD格式
- 发票类型/invoiceType：查找"发票类型"、"Invoice Type"、"Type"等

**销售方/卖方信息（Seller/Vendor/Merchant）：**
- 销售方名称/vendorName：**必须仔细查找**以下关键词后的公司名称：
  - "销售方"、"开票方"、"销货方"、"开票单位"、"销售单位"
  - "Seller"、"Vendor"、"Merchant"、"From"、"Issuer"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：销售方信息可能在发票的顶部、底部或右侧，请仔细查找整个文本
- 销售方税号/vendorTaxId：查找销售方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合
- 销售方地址/vendorAddress：查找销售方信息区域中的"地址"、"Address"、"Location"等

**购买方/买方信息（Buyer/Purchaser/Customer）：**
- 购买方名称/buyerName：**必须仔细查找**以下关键词后的公司名称：
  - "购买方"、"买方"、"购货方"、"购买单位"、"付款单位"
  - "Buyer"、"Purchaser"、"Customer"、"To"、"Bill To"
  - 如果看到"名称:"、"Name:"等标签，查找其后的公司名称
  - 注意：购买方信息可能在发票的顶部、底部或左侧，请仔细查找整个文本
- 购买方税号/buyerTaxId：查找购买方信息区域中的：
  - "纳税人识别号"、"统一社会信用代码"、"税号"、"Tax ID"、"Tax Number"、"EIN"、"VAT Number"
  - 通常是一个18位或15位的字母数字组合

**金额信息：**
- 金额/amount：查找"合计金额"、"金额合计"、"Subtotal"、"Amount"、"Net Amount"（不含税）
- 税额/taxAmount：查找"税额合计"、"税额"、"Tax Amount"、"VAT"、"Tax"（如果显示"免税"、"Tax Exempt"、"***"则为0）
- 价税合计/totalAmount：查找"价税合计"、"总计"、"Total Amount"、"Total"、"Grand Total"（含税总金额）
- 货币/currency：查找货币类型，如"CNY"、"USD"、"EUR"、"JPY"等，默认为"CNY"

**其他字段：**
- 开票人/issuer：查找"开票人"、"Issuer"、"Issued By"等
- 价税合计大写/totalAmountInWords：查找"价税合计大写"、"Amount in Words"等
- 发票分类/category：**AI分析字段**，根据发票内容（项目名称、销售方、金额等）智能判断分类，必须是以下之一：
  - "交通"：出租车、网约车、机票、火车票、船票、停车费等交通相关费用
  - "住宿"：酒店、宾馆、民宿等住宿相关费用
  - "餐饮"：餐厅、外卖、食品、饮料等餐饮相关费用
  - "娱乐"：电影、KTV、游戏、旅游景点门票等娱乐相关费用
  - "通讯"：电话费、网络费、手机费、宽带费等通讯相关费用
  - "办公用品"：文具、办公设备、打印、复印等办公用品相关费用
  - "培训"：培训费、教育费、课程费等培训相关费用
  - "其他"：不属于以上分类的其他费用，或无法确定分类时返回此值
- 项目明细/items：从表格中提取所有项目行，包括名称、单价、数量、金额、税率、税额

**重要要求：**
1. **字段完整性**：必须返回上述JSON结构中的所有字段，不能省略任何字段
2. **只返回纯JSON对象**：不要使用markdown代码块（不要用\`\`\`json包裹），直接返回JSON对象
3. **不要添加任何解释文字或说明**：只返回JSON数据
4. **空值处理**：如果某个字段无法识别，必须返回 null（字符串字段和数字字段都返回 null，不是空字符串或0）
5. **无论发票是中文还是英文，都必须使用上述JSON字段名返回（vendorName, buyerName等），不要使用Seller, Buyer等英文字段名**
6. **特别注意：销售方和购买方信息是发票的核心信息，必须仔细查找整个文本，不要遗漏**
7. 仔细区分"销售方/Seller"和"购买方/Buyer"，不要混淆
8. 如果文本中有"购买方信息"或"销售方信息"这样的标题，其下的内容就是对应的信息
9. 日期格式必须转换为YYYY-MM-DD格式，如果未识别则返回 null
10. 金额字段必须是数字类型，不要包含货币符号，如果未识别则返回 null
11. **items 数组**：如果未识别到项目明细，返回空数组 []，数组中的每个对象必须包含所有字段（name, unitPrice, quantity, amount, taxRate, taxAmount），未识别的字段返回 null`;

// ============================================
// Mistral Chat API 备选方法的用户提示词模板
// ============================================
const MISTRAL_CHAT_USER_PROMPT_TEMPLATE = (textContent) => `请从以下发票文本中提取信息：

**特别注意：**
1. 必须仔细查找销售方（开票方）和购买方（买方）的完整信息，包括名称和税号
2. 销售方和购买方信息可能在文本的不同位置，请完整扫描整个文本
3. 如果看到"购买方信息"、"销售方信息"等标题，其下的内容就是对应的信息
4. 查找"名称:"、"统一社会信用代码"、"纳税人识别号"等标签后的值

发票文本：
${textContent || '这是一张发票，请尝试识别其中的信息。'}`;

// ============================================
// 导出所有提示词
// ============================================
module.exports = {
  OCR_PROMPT,
  AI_ANALYSIS_SYSTEM_PROMPT,
  AI_ANALYSIS_USER_PROMPT_TEMPLATE,
  MISTRAL_CHAT_SYSTEM_PROMPT,
  MISTRAL_CHAT_USER_PROMPT_TEMPLATE,
};

